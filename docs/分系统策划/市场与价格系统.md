# 市场与价格系统策划文档

## 1. 系统概述

市场与价格系统负责模拟经济中的供需关系和价格形成机制。系统采用动态定价模型，价格根据市场供需实时调整，影响生产决策和人口消费行为。

---

## 2. 核心概念

### 2.1 市场（Market）
市场是商品交易的虚拟场所，每个国家/地区拥有一个本地市场。

```typescript
interface Market {
  id: string;
  name: string;
  
  // 市场范围
  regions: RegionId[];
  
  // 商品价格
  prices: Map<GoodsId, Price>;
  
  // 供需数据
  supply: Map<GoodsId, number>;
  demand: Map<GoodsId, number>;
  
  // 库存
  stockpile: Map<GoodsId, number>;
}
```

### 2.2 价格（Price）
价格由基础价格和市场供需决定。

```typescript
interface Price {
  basePrice: number;      // 基础价格（参考值）
  currentPrice: number;   // 当前价格
  previousPrice: number;  // 上周期价格
  
  // 价格历史
  history: PriceRecord[];
}

interface PriceRecord {
  date: GameDate;
  price: number;
  supply: number;
  demand: number;
}
```

---

## 3. 定价机制

### 3.1 价格计算公式

采用迭代调整的供需均衡模型：

```
供需比 = 总供给 / 总需求

价格调整系数 = f(供需比)

新价格 = 当前价格 × 价格调整系数
```

### 3.2 价格调整函数

```typescript
function calculatePriceAdjustment(supplyDemandRatio: number): number {
  // 使用非线性函数，价格调整幅度有上下限
  // 供需比 = 1 时，价格不变
  // 供需比 < 1 时，价格上涨
  // 供需比 > 1 时，价格下跌
  
  const elasticity = 0.1; // 价格弹性系数
  const maxAdjustment = 0.2; // 单周期最大调整幅度 20%
  
  // 对数调整函数
  let adjustment = Math.log(supplyDemandRatio) * elasticity;
  
  // 限制调整幅度
  adjustment = Math.max(-maxAdjustment, Math.min(maxAdjustment, adjustment));
  
  return 1 + adjustment;
}
```

### 3.3 供需计算

```typescript
// 总供给
totalSupply = production + imports - exports + stockpileRelease

// 总需求
totalDemand = consumption + productionInput + stockpileAcquisition + exports - imports
```

---

## 4. 价格影响因子

### 4.1 基础价格表

商品基础价格（以石器时代货币单位为基准）：

| 商品类别 | 商品 | 基础价格 | 说明 |
|----------|------|----------|------|
| 食物 | 谷物 | 10 | 基础口粮 |
| 食物 | 肉类 | 30 | 高级食物 |
| 食物 | 面包 | 25 | 加工食品 |
| 原料 | 木材 | 5 | 基础建材 |
| 原料 | 石材 | 8 | 建筑材料 |
| 原料 | 铁矿 | 20 | 工业原料 |
| 工具 | 石器 | 15 | 早期工具 |
| 工具 | 铁器 | 50 | 传统工具 |
| 工具 | 机械 | 200 | 工业工具 |
| 奢侈品 | 珠宝 | 500 | 财富储存 |
| 奢侈品 | 香料 | 300 | 贵族消费 |
| 工业品 | 钢材 | 100 | 工业基础 |
| 工业品 | 煤炭 | 15 | 能源 |
| 现代品 | 电子元件 | 150 | 信息时代 |
| 现代品 | 软件 | 500 | 高附加值 |

### 4.2 时代价格调整

不同时代商品价值相对变化：

```
实际基础价格 = 表定基础价格 × 时代价格系数 × 通胀系数
```

| 时代 | 价格系数 | 说明 |
|------|----------|------|
| 石器 | 1.0 | 基准 |
| 青铜 | 1.2 | 金属货币引入 |
| 铁器 | 1.5 | 贸易发展 |
| 中世纪 | 2.0 | 商业繁荣 |
| 工业革命 | 5.0 | 工业化 |
| 电气 | 10.0 | 大规模生产 |
| 信息 | 20.0 | 全球化 |
| AI | 50.0 | 高度发达 |

---

## 5. 供给来源

### 5.1 国内生产
- 建筑产出直接进入本地市场
- 产出量受生产效率影响

### 5.2 进出口

```typescript
interface Trade {
  id: string;
  fromMarket: MarketId;
  toMarket: MarketId;
  goods: GoodsId;
  
  amount: number;         // 贸易量
  price: number;          // 成交价格
  
  transportCost: number;  // 运输成本
  tariff: number;         // 关税
  
  status: TradeStatus;    // 贸易状态
}
```

### 5.3 库存释放
- 玩家/国家库存可投放市场
- 紧急情况下的价格干预手段

---

## 6. 需求来源

### 6.1 人口消费

```typescript
interface PopulationDemand {
  // 基础需求（必需品）
  basicNeeds: Map<GoodsId, number>;  // 每千人需求量
  
  // 中级需求（改善品）
  improvedNeeds: Map<GoodsId, number>;
  
  // 高级需求（奢侈品）
  luxuryNeeds: Map<GoodsId, number>;
  
  // 需求满足后才会消费更高级商品
}
```

需求优先级：
1. **生存需求**：食物、住所 → 不满足会死亡
2. **基础需求**：衣物、简单工具 → 不满足降低效率
3. **改善需求**：家具、更好食物 → 提升生活水平
4. **奢侈需求**：珠宝、艺术品 → 提升满意度

### 6.2 生产投入
- 工厂生产消耗原料
- 消耗量由生产方式和产量决定

### 6.3 库存积累
- 玩家/国家主动囤积
- 安全库存自动补充

### 6.4 建设/升级
- 新建建筑的物资消耗
- 建筑升级的物资消耗

---

## 7. 价格波动机制

### 7.1 短期波动

| 因素 | 影响幅度 | 持续时间 |
|------|----------|----------|
| 季节变化 | ±10% | 季度周期 |
| 自然灾害 | ±30% | 短期 |
| 突发事件 | ±20% | 事件相关 |
| 投机行为 | ±15% | 短期 |

### 7.2 长期趋势

| 因素 | 影响方向 | 说明 |
|------|----------|------|
| 科技进步 | 下跌 | 生产效率提升 |
| 人口增长 | 上涨 | 需求增加 |
| 资源枯竭 | 上涨 | 供给受限 |
| 新替代品 | 下跌 | 需求转移 |

### 7.3 经济周期

```
繁荣期 → 过热期 → 衰退期 → 复苏期 → 繁荣期
  ↑                                    ↓
  └────────────────────────────────────┘
```

周期参数：
- 周期长度：50-200 游戏日
- 价格波动幅度：±30%
- 受多种因素触发

---

## 8. 市场事件

### 8.1 随机事件

| 事件类型 | 触发条件 | 效果 |
|----------|----------|------|
| 丰收 | 农业+天气 | 粮食供给+20%，价格-15% |
| 欠收 | 农业+天气 | 粮食供给-30%，价格+25% |
| 矿难 | 采矿建筑 | 产量暂停，价格+10% |
| 技术突破 | 科技研发 | 相关商品生产效率+10% |
| 瘟疫 | 人口密集 | 劳动力-10%，需求-15% |
| 贸易中断 | 外交关系 | 进出口受阻，价格波动 |

### 8.2 事件生成规则

```typescript
interface MarketEvent {
  id: string;
  type: EventType;
  
  // 触发条件
  conditions: {
    minPopulation?: number;
    minEra?: Era;
    requiredBuildings?: BuildingType[];
    probability: number;  // 每周期触发概率
  };
  
  // 效果
  effects: {
    supplyModifier?: Map<GoodsId, number>;
    demandModifier?: Map<GoodsId, number>;
    priceModifier?: Map<GoodsId, number>;
    duration: number;  // 持续天数
  };
}
```

---

## 9. 贸易系统

### 9.1 国内贸易
- 国内各地区市场自动整合
- 贸易成本 = 运输成本（基于距离）

### 9.2 国际贸易

```typescript
interface TradeRoute {
  id: string;
  from: MarketId;
  to: MarketId;
  
  // 贸易商品
  goods: {
    goodsId: GoodsId;
    amount: number;      // 约定数量
    price: number;       // 约定价格
  }[];
  
  // 贸易条件
  transportCost: number; // 每单位运输成本
  tariff: number;        // 关税率
  
  // 状态
  efficiency: number;    // 贸易效率 0-1
  isActive: boolean;
}
```

### 9.3 贸易平衡

```
贸易顺差 = 出口总额 - 进口总额
```

长期贸易不平衡影响：
- 顺差 → 货币升值 → 出口竞争力下降
- 逆差 → 货币贬值 → 进口成本上升

---

## 10. 价格干预

### 10.1 玩家可执行操作

| 操作 | 效果 | 成本 |
|------|------|------|
| 价格上限 | 限制最高价 | 补贴支出 |
| 价格下限 | 限制最低价 | 收购成本 |
| 定量配给 | 限制购买量 | 行政成本 |
| 战略储备 | 建立库存 | 采购成本 |
| 投放储备 | 增加供给 | 库存减少 |

### 10.2 干预代价

- 价格扭曲 → 市场效率下降
- 财政支出 → 国库负担
- 黑市交易 → 市场失控风险

---

## 11. UI设计

### 11.1 市场总览面板

```
┌─────────────────────────────────────────────────────────────┐
│ 📈 市场总览                                     [本日] [本周] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 市场指数: 1250.3 (+2.1%)  贸易顺差: ¥5,400                  │
│                                                             │
│ ─── 价格变动 TOP 5 ─────────────────────────────────────    │
│ 📊 钢材   ¥108 ↑ +12%   🔥 需求激增                         │
│ 📊 煤炭   ¥18  ↑ +8%    ⚡ 工业扩张                         │
│ 📊 谷物   ¥9   ↓ -5%    🌾 丰收                             │
│ 📊 木材   ¥6   ↓ -3%    ─── 供给充足                        │
│ 📊 铁器   ¥52  ↑ +4%    🏭 生产需求                         │
│                                                             │
│ ─── 商品分类 ───────────────────────────────────────────    │
│ [全部] [食物] [原料] [工具] [工业品] [奢侈品]               │
│                                                             │
│ ─── 商品列表 ───────────────────────────────────────────    │
│ 商品      价格    变化   供给    需求    平衡               │
│ 谷物      ¥9.5    -5%   1200    1000    +200  [详情]        │
│ 铁矿      ¥22     +3%    500     600    -100  [详情]        │
│ 钢材      ¥108    +12%   200     280    -80   [详情]        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 11.2 商品详情面板

```
┌─────────────────────────────────────────────────────────────┐
│ 📦 钢材                                        [×] 关闭      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 当前价格: ¥108    基础价格: ¥100    价格指数: 1.08          │
│                                                             │
│ ─── 价格走势 ──────────────────────────────────────────     │
│ 120 ┤                                                      │
│ 110 ┤        ╭──╮                                          │
│ 100 ┤   ╭────╯  ╰───                                       │
│  90 ┤───╯                                                   │
│     └───────────────────────────────                        │
│      7天前  5天前  3天前  昨天  今天                         │
│                                                             │
│ ─── 供需状况 ──────────────────────────────────────────     │
│ 供给: 200/天  [国内生产: 180 | 进口: 20]                    │
│ 需求: 280/天  [生产消耗: 250 | 建设消耗: 30]                │
│ 缺口: -80/天                                               │
│                                                             │
│ ─── 主要生产者 ─────────────────────────────────────────   │
│ • 钢铁厂 #1    产出 100/天                                  │
│ • 钢铁厂 #2    产出 80/天                                   │
│                                                             │
│ ─── 主要消费者 ─────────────────────────────────────────   │
│ • 机械厂 #1    消耗 120/天                                  │
│ • 汽车厂 #1    消耗 80/天                                   │
│ • 建设项目     消耗 50/天                                   │
│                                                             │
│ [建立储备]  [紧急进口]  [设置价格管制]                      │
└─────────────────────────────────────────────────────────────┘
```

### 11.3 价格图表

```
┌─────────────────────────────────────────────────────────────┐
│ 📊 价格走势图 - 钢材                                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 价格                                                        │
│ 120 ┤              ╭──╮                                     │
│ 110 ┤         ╭────╯  ╰────╮                                │
│ 100 ┤    ╭────╯            ╰───                             │
│  90 ┤────╯                                                  │
│  80 ┤                                                       │
│     └─────────────────────────────────────────────────────  │
│        1月   2月   3月   4月   5月   6月                     │
│                                                             │
│ ─── 图例 ───────────────────────────────────────────────    │
│ ━━━ 价格  ┄┄┄ 供给量  ─── 需求量                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 12. 数据平衡

### 12.1 价格弹性
- 必需品弹性低（0.3-0.5）
- 奢侈品弹性高（1.5-2.0）
- 工业原料中等（0.8-1.2）

### 12.2 供需平衡目标
- 正常状态：供需比 0.9-1.1
- 短缺状态：供需比 < 0.8
- 过剩状态：供需比 > 1.2

### 12.3 库存安全线
- 食物：7天消费量
- 工业原料：14天消费量
- 奢侈品：无硬性要求
