# 技术栈文档

## 1. 项目概述

本项目是一款基于Web的经济模拟游戏，核心玩法参考Paradox的《维多利亚3》，实现工厂生产、价格波动、雇佣员工、科技升级等核心经济系统。时代跨度从石器时代到现代AI时代。

**架构设计原则：**
- 游戏核心逻辑与UI层严格分离
- 核心逻辑使用纯TypeScript实现，无框架依赖
- 为后续迁移到Cocos Creator做准备
- 前后端共用核心逻辑代码

---

## 2. 架构设计

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        客户端层                              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────────────────────┐ │
│  │   Vue3 UI层     │    │      游戏核心逻辑层 (Core)       │ │
│  │  ─────────────  │    │  ─────────────────────────────  │ │
│  │  - 页面组件     │◄───│  - 经济系统                     │ │
│  │  - 状态展示     │    │  - 生产系统                     │ │
│  │  - 用户交互     │    │  - 人口系统                     │ │
│  │  - 动画效果     │    │  - 科技系统                     │ │
│  └─────────────────┘    │  - 时间系统                     │ │
│                         │  - 存档系统                     │ │
│                         └─────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                      通信层 (API/Socket)                     │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐│
│  │                    后端服务层                            ││
│  │  ─────────────────────────────────────────────────────  ││
│  │  - 定时数据持久化存储                                    ││
│  │  - 用户认证与授权                                        ││
│  │  - 存档管理                                              ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### 2.2 核心逻辑层设计原则

| 原则 | 说明 |
|------|------|
| 框架无关 | 核心逻辑不依赖Vue/React等UI框架 |
| 平台无关 | 可在浏览器、Node.js、Cocos Creator中运行 |
| 纯函数优先 | 游戏计算逻辑使用纯函数，便于测试和复用 |
| 接口抽象 | 通过接口层与UI框架解耦 |

---

## 3. 前端技术栈

### 3.1 核心框架
| 技术 | 版本 | 用途 |
|------|------|------|
| Vue | 3.x | UI框架 |
| TypeScript | 5.x | 类型安全 |
| Vite | 5.x | 构建工具 |

### 3.2 状态管理
| 技术 | 用途 |
|------|------|
| Pinia | UI层状态管理（接收核心逻辑状态，分发给组件） |

### 3.3 UI组件库
| 技术 | 用途 |
|------|------|
| Tailwind CSS | 样式系统 |
| Headless UI | 无样式组件基础 |
| VueUse | Vue组合式API工具集 |
| Framer Motion / @vueuse/motion | 动画效果 |
| ECharts | 图表可视化（经济数据展示） |

### 3.4 地图与可视化
| 技术 | 用途 |
|------|------|
| Leaflet / MapLibre GL | 2D地图渲染 |
| D3.js | 复杂数据可视化 |
| Canvas API | 高性能图形渲染（生产链可视化） |

---

## 4. 游戏核心逻辑层 (Core)

### 4.1 设计目标

```
packages/core/          # 核心逻辑包（框架无关、平台无关）
├── src/
│   ├── systems/        # 游戏系统
│   │   ├── economy/    # 经济系统
│   │   ├── production/ # 生产系统
│   │   ├── population/ # 人口系统
│   │   ├── technology/ # 科技系统
│   │   └── time/       # 时间系统
│   ├── models/         # 数据模型
│   ├── algorithms/     # 核心算法
│   ├── interfaces/     # 接口定义
│   ├── utils/          # 工具函数
│   └── serialization/  # 序列化/反序列化
└── package.json
```

### 4.2 核心系统模块

| 模块 | 职责 | 技术方案 |
|------|------|----------|
| 经济系统 | 价格计算、供需均衡 | 瓦尔拉斯均衡算法 |
| 生产系统 | 工厂运营、生产链 | 线性规划优化 |
| 人口系统 | 人口增长、就业、需求 | 基于效用的决策模型 |
| 科技系统 | 科技树、研发进度 | 概率扩散模型 |
| 时间系统 | 游戏时间推进 | 基于Tick的离散事件模拟 |
| 存档系统 | 状态序列化 | BSON（MongoDB存储） |

### 4.3 核心算法
| 功能 | 算法/方案 |
|------|----------|
| 价格均衡 | 迭代价格调整算法（瓦尔拉斯均衡） |
| 生产优化 | 线性规划（Simplex算法） |
| 人口行为 | 基于效用的决策模型 |
| 科技扩散 | 概率扩散模型 |

### 4.4 接口抽象设计

```typescript
// 核心逻辑层通过接口与UI层通信
interface IGameEventEmitter {
  emit(event: GameEvent): void;
  on(eventType: string, handler: EventHandler): void;
  off(eventType: string, handler: EventHandler): void;
}

interface IGameStateProvider {
  getState(): GameState;
  subscribe(listener: StateListener): () => void;
}

interface ISaveManager {
  save(state: GameState): Promise<void>;
  load(saveId: string): Promise<GameState>;
  listSaves(): Promise<SaveInfo[]>;
}
```

---

## 5. 后端技术栈

### 5.1 核心框架
| 技术 | 版本 | 用途 |
|------|------|------|
| Node.js | 20.x LTS | 运行时环境 |
| Fastify | 4.x | Web框架（高性能） |
| TypeScript | 5.x | 类型安全 |

### 5.2 数据库
| 技术 | 用途 |
|------|------|
| MongoDB | 主数据库（文档型数据库） |
| Mongoose | ODM |

### 5.3 实时通信
| 技术 | 用途 |
|------|------|
| Socket.io | WebSocket实时通信（可选，用于多人同步） |

### 5.4 后端职责（简化）

```
后端职责范围：
├── 用户认证与授权
├── 存档管理
│   ├── 定时自动保存
│   ├── 手动保存
│   └── 存档列表查询
├── 数据持久化
│   └── 游戏状态存储
└── 可选：多人游戏同步
```

---

## 6. 代码共享策略

### 6.1 Monorepo结构

```
WebVic3/
├── apps/
│   ├── web/                    # Vue3前端应用
│   │   ├── src/
│   │   │   ├── components/     # UI组件
│   │   │   ├── views/          # 页面视图
│   │   │   ├── stores/         # Pinia状态
│   │   │   ├── composables/    # Vue组合式函数
│   │   │   └── adapters/       # 核心逻辑适配器
│   │   └── ...
│   └── server/                 # Node.js后端应用
│       ├── src/
│       │   ├── routes/         # API路由
│       │   ├── services/       # 业务逻辑
│       │   └── models/         # 数据模型
│       └── ...
├── packages/
│   ├── core/                   # 游戏核心逻辑（共享）
│   │   ├── src/
│   │   │   ├── systems/        # 游戏系统
│   │   │   ├── models/         # 数据模型
│   │   │   ├── algorithms/     # 核心算法
│   │   │   ├── interfaces/     # 接口定义
│   │   │   └── index.ts        # 导出
│   │   └── package.json
│   ├── types/                  # 共享类型定义
│   └── ui-vue/                 # Vue共享组件（可选）
├── docs/                       # 文档
└── models/                     # 数据库模型（Mongoose Schemas）
```

### 6.2 核心逻辑包导出

```typescript
// packages/core/src/index.ts
export * from './systems/economy';
export * from './systems/production';
export * from './systems/population';
export * from './systems/technology';
export * from './systems/time';
export * from './models';
export * from './interfaces';
export * from './serialization';
```

### 6.3 前端使用核心逻辑

```typescript
// apps/web/src/adapters/GameAdapter.ts
import { 
  GameEngine, 
  GameState, 
  IGameEventEmitter 
} from '@vic3/core';

export class GameAdapter {
  private engine: GameEngine;
  
  constructor() {
    this.engine = new GameEngine();
  }
  
  getState(): GameState {
    return this.engine.getState();
  }
  
  tick(): void {
    this.engine.tick();
  }
}
```

---

## 7. Cocos Creator迁移规划

### 7.1 兼容性设计

| 设计要点 | 说明 |
|----------|------|
| 核心逻辑独立 | packages/core 可直接在Cocos Creator中使用 |
| 无DOM依赖 | 核心逻辑不使用浏览器特有API |
| 标准TypeScript | 使用标准TS，避免框架特定语法 |
| 数据模型统一 | 前端、后端、Cocos Creator共用数据结构 |

### 7.2 迁移后的架构

```
┌─────────────────────────────────────────────────────────────┐
│                     Cocos Creator客户端                      │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────────────────────┐ │
│  │  Cocos UI层     │    │      游戏核心逻辑层 (Core)       │ │
│  │  ─────────────  │    │  (与Web版共用同一套代码)         │ │
│  │  - 场景渲染     │◄───│                                 │ │
│  │  - 2D/3D展示    │    │                                 │ │
│  │  - 交互控制     │    │                                 │ │
│  └─────────────────┘    └─────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                      Node.js后端服务                         │
│                   (与Web版共用后端)                          │
└─────────────────────────────────────────────────────────────┘
```

### 7.3 迁移步骤

1. **阶段一：Web验证**（当前）
   - 使用Vue3实现UI层
   - 核心逻辑在packages/core中开发
   - 验证游戏机制和数值平衡

2. **阶段二：核心逻辑完善**
   - 完善所有游戏系统
   - 编写完整的单元测试
   - 优化性能

3. **阶段三：Cocos Creator迁移**
   - 创建Cocos Creator项目
   - 引入packages/core
   - 实现Cocos UI层
   - 复用Node.js后端

---

## 8. 开发环境

### 8.1 本地开发
| 技术 | 用途 |
|------|------|
| Vite HMR | 热模块替换（修改代码自动刷新） |
| concurrently | 同时启动前后端服务 |
| nodemon | 后端代码变更自动重启 |

### 8.2 启动命令
```bash
# 安装依赖
pnpm install

# 启动开发环境（前端 + 后端）
pnpm dev

# 仅启动前端
pnpm dev:web

# 仅启动后端
pnpm dev:server
```

---

## 9. 开发工具

| 工具 | 用途 |
|------|------|
| ESLint | 代码规范 |
| TypeScript | 类型检查 |

---

## 10. 性能考量

### 10.1 前端优化
- 虚拟列表（大规模数据渲染）
- Web Worker（复杂计算移至核心逻辑层）
- Vue3响应式优化（shallowRef、markRaw）
- 按需加载（路由级代码分割）

### 10.2 核心逻辑优化
- 纯函数设计（便于缓存和测试）
- 增量计算（只计算变化部分）
- 对象池（减少GC压力）
- 时间切片（避免长任务阻塞UI）

### 10.3 后端优化
- 定时批量保存（减少数据库压力）
- 数据库连接池

---

## 11. 扩展性设计

### 11.1 模块化经济系统
- 商品、建筑、科技均为配置驱动
- 支持热加载配置
- 预留MOD支持接口

### 11.2 多人游戏支持（未来）
- 房间式多人游戏
- 状态同步 + 锁步机制
- 断线重连支持

---