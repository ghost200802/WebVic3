# 技术栈文档

## 1. 项目概述

本项目是一款基于Web的经济模拟游戏，核心玩法参考Paradox的《维多利亚3》，实现工厂生产、价格波动、雇佣员工、科技升级等核心经济系统。时代跨度从石器时代到现代AI时代。

---

## 2. 前端技术栈

### 2.1 核心框架
| 技术 | 版本 | 用途 |
|------|------|------|
| React | 18.x | UI框架 |
| TypeScript | 5.x | 类型安全 |
| Vite | 5.x | 构建工具 |

### 2.2 状态管理
| 技术 | 用途 |
|------|------|
| Zustand | 全局状态管理（轻量级，适合游戏状态） |
| Immer | 不可变数据更新 |

### 2.3 UI组件库
| 技术 | 用途 |
|------|------|
| Tailwind CSS | 样式系统 |
| Headless UI | 无样式组件基础 |
| Framer Motion | 动画效果 |
| Recharts | 图表可视化（经济数据展示） |

### 2.4 地图与可视化
| 技术 | 用途 |
|------|------|
| Leaflet / MapLibre GL | 2D地图渲染 |
| D3.js | 复杂数据可视化 |
| Canvas API | 高性能图形渲染（生产链可视化） |

---

## 3. 后端技术栈

### 3.1 核心框架
| 技术 | 版本 | 用途 |
|------|------|------|
| Node.js | 20.x LTS | 运行时环境 |
| Fastify | 4.x | Web框架（高性能） |
| TypeScript | 5.x | 类型安全 |

### 3.2 数据库
| 技术 | 用途 |
|------|------|
| PostgreSQL | 主数据库（关系型数据） |
| Redis | 缓存 + 实时数据 |
| Prisma | ORM |

### 3.3 实时通信
| 技术 | 用途 |
|------|------|
| Socket.io | WebSocket实时通信 |
| BullMQ | 任务队列（经济计算） |

---

## 4. 游戏引擎与模拟层

### 4.1 核心模拟引擎
```typescript
// 技术选型理由：
// - 纯TypeScript实现，便于调试和维护
// - 基于事件驱动的Tick系统
// - 模块化的经济模型设计
```

| 模块 | 技术方案 |
|------|----------|
| 时间系统 | 基于Tick的离散事件模拟 |
| 经济计算 | 线性规划 + 供需均衡算法 |
| AI决策 | 行为树 + 效用系统 |
| 数据序列化 | Protocol Buffers |

### 4.2 关键算法
| 功能 | 算法/方案 |
|------|----------|
| 价格均衡 | 迭代价格调整算法（瓦尔拉斯均衡） |
| 生产优化 | 线性规划（Simplex算法） |
| 人口行为 | 基于效用的决策模型 |
| 科技扩散 | 概率扩散模型 |

---

## 5. 部署架构

### 5.1 基础设施
| 技术 | 用途 |
|------|------|
| Docker | 容器化 |
| Kubernetes | 容器编排（可选，大规模时） |
| Nginx | 反向代理 |

### 5.2 存储与CDN
| 技术 | 用途 |
|------|------|
| AWS S3 / MinIO | 静态资源存储 |
| CloudFlare | CDN + DDoS防护 |

---

## 6. 开发工具

| 工具 | 用途 |
|------|------|
| ESLint + Prettier | 代码规范 |
| Vitest | 单元测试 |
| Playwright | E2E测试 |
| Turborepo | Monorepo管理（如需多包） |
| Storybook | UI组件开发 |

---

## 7. 目录结构

```
WebVic3/
├── apps/
│   ├── web/                 # 前端应用
│   │   ├── src/
│   │   │   ├── components/  # UI组件
│   │   │   ├── pages/       # 页面
│   │   │   ├── stores/      # Zustand状态
│   │   │   ├── hooks/       # 自定义Hooks
│   │   │   └── utils/       # 工具函数
│   │   └── ...
│   └── server/              # 后端应用
│       ├── src/
│       │   ├── routes/      # API路由
│       │   ├── services/    # 业务逻辑
│       │   ├── models/      # 数据模型
│       │   └── game/        # 游戏核心逻辑
│       └── ...
├── packages/
│   ├── engine/              # 游戏引擎核心
│   ├── types/               # 共享类型定义
│   └── ui/                  # 共享UI组件
├── docs/                    # 文档
└── prisma/                  # 数据库Schema
```

---

## 8. 性能考量

### 8.1 前端优化
- 虚拟列表（大规模数据渲染）
- Web Worker（复杂计算）
- React.memo + useMemo（减少重渲染）
- 按需加载（路由级代码分割）

### 8.2 后端优化
- 经济计算异步化（BullMQ队列）
- Redis缓存热点数据
- 数据库连接池
- 增量更新（只传输变化数据）

---

## 9. 扩展性设计

### 9.1 模块化经济系统
- 商品、建筑、科技均为配置驱动
- 支持热加载配置
- 预留MOD支持接口

### 9.2 多人游戏支持（未来）
- 房间式多人游戏
- 状态同步 + 锁步机制
- 断线重连支持
