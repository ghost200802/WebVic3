# 生产系统 - 生产计算

## 概述

生产计算是生产系统的核心逻辑，决定了建筑的实际产出、投入消耗和效率表现。本文档详细描述生产计算的各个方面。

---

## 基础产出计算

### 产出公式

```
实际产出 = 基础产能 × 生产方式修正 × 工人效率 × 科技修正 × 设施修正
```

### 各项系数说明

#### 1. 基础产能

- 由建筑类型和等级决定
- 是生产计算的基准值
- 通过建筑升级可提升

#### 2. 生产方式修正

- 由选择的生产方式决定
- 不同的生产方式有不同的产能系数
- 通常科技越先进，修正值越高

#### 3. 工人效率

工人效率 = 基础效率 × (1 + 教育水平) × (1 + 生活水平加成) × 工具加成

**基础效率**：1.0

**教育水平**：根据人口受教育程度
- 文盲：0
- 基础识字：0.1
- 小学：0.2
- 中学：0.3
- 大学：0.4
- 研究生：0.5

**生活水平加成**：根据人口生活水平
- 0-20（贫困）：0
- 20-40（困难）：0.05
- 40-60（正常）：0.1
- 60-80（良好）：0.2
- 80-100（富裕）：0.3

**工具加成**：工具商品充足度
- 工具充足：0.5
- 工具部分充足：0.25
- 工具不足：0

#### 4. 科技修正

由已解锁的科技提供全局或特定建筑的生产加成。

示例科技效果：
- 农业科技：农田产出 +5%~+50%
- 采矿科技：矿场产出 +5%~+40%
- 制造科技：工厂产出 +10%~+100%

#### 5. 设施修正

由地块开发等级、道路等级等基础设施提供的加成。

---

## 投入消耗计算

### 投入品计算

```
实际投入消耗 = 理论投入 × 实际产出 / 理论产出
```

### 投入品不足处理

当投入品库存不足时：

```
实际产出 = 理论产出 × min(各投入品充足率)

投入品充足率 = 当前库存 / 需要量
```

#### 投入品不足示例

假设某建筑需要：
- 铁矿 100单位/天
- 煤炭 50单位/天

当前库存：
- 铁矿 80单位
- 煤炭 60单位

投入品充足率：
- 铁矿：80/100 = 0.8
- 煤炭：60/50 = 1.2

实际产出 = 理论产出 × min(0.8, 1.2) = 理论产出 × 0.8

---

## 工人分配影响

### 工人数量对产能的影响

```
实际产能 = 基础产能 × (当前工人数 / 基础工位数)
```

### 工人数量范围

- 最小：0（停工）
- 最大：maxWorkers

### 工人分配示例

某工厂：
- 基础工位数：50
- 最大工位数：100
- 基础产能：100钢材/天

不同工人分配：
- 0工人：产能 = 100 × 0/50 = 0（停工）
- 25工人：产能 = 100 × 25/50 = 50
- 50工人：产能 = 100 × 50/50 = 100（标准产能）
- 75工人：产能 = 100 × 75/50 = 150（超负荷）
- 100工人：产能 = 100 × 100/50 = 200（最大产能）

### 超负荷生产

当工人数 > 基础工位数时：
- 产能可超过基础值
- 但效率可能下降
- 设备磨损加速
- 工人疲劳度增加

---

## 生产周期

### 周期定义

- 游戏内 **1天** 为一个生产周期
- 每天结束时执行一次生产计算

### 周期执行顺序

1. **计算理论产出**：根据建筑属性和生产方式
2. **计算工人效率**：根据工人属性
3. **检查投入品库存**：确定是否充足
4. **计算实际产出**：应用所有修正系数
5. **消耗投入品**：按比例扣除库存
6. **产出商品**：增加到库存
7. **计算利润**：产出价值 - 投入成本 - 运营成本

---

## 效率计算

### 总效率公式

```
总效率 = 产能效率 × 资源效率 × 工人效率 × 设施效率
```

### 产能效率

```
产能效率 = 实际产出 / 基础产能
```

影响因素：
- 工人数量
- 生产方式
- 工人技能水平

### 资源效率

```
资源效率 = min(各投入品充足率)
```

影响因素：
- 投入品库存充足度
- 运力支持
- 原料质量

### 工人效率

如上文所述，受教育水平、生活水平、工具影响。

### 设施效率

```
设施效率 = 基础设施加成 × 地块开发度加成
```

影响因素：
- 道路等级
- 地块开发等级
- 基础设施完善度

---

## 利润计算

### 利润公式

```
利润 = 产出价值 - 投入成本 - 运营成本 - 运输成本
```

### 产出价值

```
产出价值 = Σ(产出商品数量 × 市场价格)
```

### 投入成本

```
投入成本 = Σ(投入品数量 × 市场价格)
```

### 运营成本

运营成本包括：
- 工人工资
- 设备维护
- 建筑折旧

```
运营成本 = 工人工资 + 设备维护 + 建筑折旧

工人工资 = 工人数 × 平均工资
设备维护 = 基础维护 × 建筑等级
建筑折旧 = 建造成本 / 使用寿命
```

### 运输成本

```
运输成本 = 总运输量 × 运输单价
```

---

## 生产计算示例

### 示例：铁器时代矿场

#### 建筑属性
- 类型：铁矿
- 基础工位数：20
- 最大工位数：25
- 基础产能：80铁矿/天
- 建筑等级：2

#### 生产方式
- 方式：手工开采
- 产能修正：1.0
- 工人效率：1.0

#### 工人属性
- 工人数：20
- 教育水平：文盲（0）
- 生活水平：45（正常，0.1加成）
- 工具：铁器充足（0.5加成）

#### 计算过程

1. 基础产能 = 80

2. 工人效率 = 1.0 × (1 + 0) × (1 + 0.1) × (1 + 0.5) = 1.0 × 1.0 × 1.1 × 1.5 = 1.65

3. 实际产出 = 80 × 1.0 × 1.65 × 1.0 × 1.0 = 132 铁矿/天

4. 投入品：铁器 2工具/天

5. 利润计算（假设铁矿价格20，铁器价格50）：
   - 产出价值 = 132 × 20 = 2640
   - 投入成本 = 2 × 50 = 100
   - 工人工资 = 20 × 10 = 200
   - 设备维护 = 50 × 2 = 100
   - 利润 = 2640 - 100 - 200 - 100 = 2240

### 示例：工业时代钢铁厂

#### 建筑属性
- 类型：钢铁厂
- 基础工位数：50
- 最大工位数：100
- 基础产能：200钢材/天
- 建筑等级：3

#### 生产方式
- 方式：高炉炼钢
- 产能修正：1.2
- 工人效率：1.1

#### 工人属性
- 工人数：60
- 教育水平：中学（0.3）
- 生活水平：70（良好，0.2加成）
- 工具：机械工具充足（0.5加成）

#### 计算过程

1. 基础产能 = 200

2. 工人效率 = 1.0 × (1 + 0.3) × (1 + 0.2) × (1 + 0.5) = 1.0 × 1.3 × 1.2 × 1.5 = 2.34

3. 实际产出 = 200 × 1.2 × 2.34 × 1.0 × 1.0 = 561.6 ≈ 562 钢材/天

4. 投入品：铁矿 180单位/天，煤炭 90单位/天

5. 利润计算（假设钢材价格100，铁矿价格20，煤炭价格15）：
   - 产出价值 = 562 × 100 = 56200
   - 投入成本 = 180 × 20 + 90 × 15 = 3600 + 1350 = 4950
   - 工人工资 = 60 × 20 = 1200
   - 设备维护 = 100 × 3 = 300
   - 利润 = 56200 - 4950 - 1200 - 300 = 49750

---

## 生产计算接口定义

### 生产计算器接口

```typescript
interface IProductionCalculator {
  calculateProduction(
    building: Building,
    workers: number,
    era: Era,
    educationLevel: number,
    toolAvailability: number
  ): ProductionResult

  calculateUpgradeCost(building: Building): Record<string, number>
}

interface ProductionResult {
  outputs: Map<string, number>
  inputs: Map<string, number>
  efficiency: number
  profit: number
  actualOutput: number
  theoreticalOutput: number
}
```

### 计算参数说明

| 参数 | 类型 | 说明 |
|------|------|------|
| building | Building | 建筑对象 |
| workers | number | 工人数量 |
| era | Era | 当前时代 |
| educationLevel | number | 工人教育水平 0-0.5 |
| toolAvailability | number | 工具可用性 0-0.5 |

---

## 数值平衡要点

### 投入产出比

| 产品类型 | 产出价值/投入成本 | 说明 |
|----------|------------------|------|
| 原料生产 | 1.2x | 基础利润较低 |
| 中间品生产 | 1.5x | 中等利润 |
| 最终品生产 | 2.0x | 较高利润 |
| 奢侈品生产 | 2.5x | 高利润但风险大 |

### 工人产出价值

| 时代 | 工人日均产出价值 | 说明 |
|------|------------------|------|
| 石器时代 | ~10 | 低效率 |
| 青铜时代 | ~20 | 工具改善 |
| 铁器时代 | ~40 | 铁器普及 |
| 工业时代 | ~100 | 机械化 |
| 电气时代 | ~250 | 电气化 |
| 信息时代 | ~600 | 信息化 |
| AI时代 | ~1500 | 自动化 |

### 建筑成本回收

| 建筑等级 | 预计回收时间 | 说明 |
|----------|--------------|------|
| 基础建筑 | 30-60天 | 快速回本 |
| 中级建筑 | 60-90天 | 中等回本 |
| 高级建筑 | 90-120天 | 慢速回本 |

---

## 性能优化考虑

### 计算优化策略

1. **缓存计算结果**：相同条件下的计算结果可缓存
2. **批量更新**：多个建筑的批量计算优于逐个计算
3. **事件驱动**：只在状态变化时重新计算
4. **简化近似**：对非关键计算可使用近似公式

### 计算频率控制

- 核心计算：每天一次（必需）
- 效率预测：每周一次（可选）
- 利润估算：每天一次（必需）
