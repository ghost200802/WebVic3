# 阶段4.1.1：库存系统

## 目标

实现统一的库存管理系统，提供地块库存和全局库存的统一操作接口，为后续地块间物品运输功能预留扩展空间。

**重要提示：**
- 本文档只包含接口定义和功能要求，不包含详细代码实现
- 完成后必须进行单元测试
- 测试覆盖率 > 80% 才能进入下一阶段

---

## 任务清单

- [ ] 实现StorageManager库存管理器
- [ ] 实现地块库存操作接口
- [ ] 实现全局库存操作接口
- [ ] 实现库存查询与汇总功能
- [ ] 集成到现有reducers
- [ ] 编写单元测试

---

## 核心设计说明

### 库存架构

**双层库存结构：**

1. **地块库存**
   - 每个地块拥有独立的库存空间
   - 存储该地块生产的所有商品
   - 生产建筑只能使用本地块的库存商品作为原料
   - 地块库存为只读视图，仅通过StorageManager操作

2. **全局库存**
   - 全局统一的库存汇总
   - 由所有地块库存总和计算得出
   - 用于整体资源统计和UI显示
   - 支持手动添加/移除操作（如市场交易）

**数据流转：**
- 生产建筑产出 → 存入地块库存
- 地块库存变动 → 自动同步到全局库存
- 市场交易 → 直接操作全局库存
- 地块间运输（预留） → 从源地块移动到目标地块

### 命名规范

- **Goods**: 表示库存中的物品/商品
- **Storage**: 表示库存/仓库
- **TileStorage**: 地块库存
- **GlobalStorage**: 全局库存

---

## 接口定义要求

### StorageOperationResult接口

```
interface StorageOperationResult {
  success: boolean
  actualAmount: number
  message?: string
}
```

### StorageSummary接口

```
interface StorageSummary {
  tileId: string
  tileName: string
  goods: Map<string, number>
  totalItems: number
}
```

### IStorageManager接口

```
interface IStorageManager {
  constructor(state: GameState)
  updateState(state: GameState): void

  getTileStorage(tileId: string): Map<string, number>
  getGlobalStorage(): Map<string, number>
  
  getGoodsFromTile(tileId: string, goodsId: string): number
  getGoodsFromGlobal(goodsId: string): number
  
  hasGoodsInTile(tileId: string, goodsId: string, amount: number): boolean
  hasGoodsInGlobal(goodsId: string, amount: number): boolean
  
  addGoodsToTile(tileId: string, goodsId: string, amount: number): StorageOperationResult
  removeGoodsFromTile(tileId: string, goodsId: string, amount: number): StorageOperationResult
  setGoodsInTile(tileId: string, goodsId: string, amount: number): StorageOperationResult
  
  transferGoodsToGlobal(tileId: string, goodsId: string, amount: number): StorageOperationResult
  addGoodsToGlobal(goodsId: string, amount: number): StorageOperationResult
  removeGoodsFromGlobal(goodsId: string, amount: number): StorageOperationResult
  setGoodsInGlobal(goodsId: string, amount: number): StorageOperationResult
  
  clearTileStorage(tileId: string): boolean
  clearGlobalStorage(): void
  
  getTileStorageSummary(tileId: string): StorageSummary | null
  getAllTileStorageSummaries(): StorageSummary[]
  getGlobalStorageSummary(): { goods: Map<string, number>; totalItems: number }
  
  syncGlobalStorageFromTiles(): void
  
  getGoodsList(tileId: string): Array<{ goodsId: string; amount: number }>
  getGlobalGoodsList(): Array<{ goodsId: string; amount: number }>
}
```

---

## 功能要求

### 地块库存管理功能

- 获取指定地块的完整库存
- 获取指定地块中特定商品的数量
- 检查地块库存是否包含足够数量的商品
- 向地块库存添加商品
- 从地块库存移除商品（支持超额移除自动限制）
- 设置地块库存中商品的数量
- 清空地块库存
- 获取地块库存汇总信息（包含总数量）
- 获取地块库存商品列表

### 全局库存管理功能

- 获取全局库存
- 获取全局库存中特定商品的数量
- 检查全局库存是否包含足够数量的商品
- 向全局库存添加商品
- 从全局库存移除商品（支持超额移除自动限制）
- 设置全局库存中商品的数量
- 清空全局库存
- 获取全局库存汇总信息（包含总数量）
- 获取全局库存商品列表

### 库存转移功能

- 将商品从地块库存转移到全局库存
- 转移前检查源地块库存是否充足
- 返回转移结果和实际转移数量

### 库存同步功能

- 从所有地块库存重新计算全局库存
- 清空现有全局库存
- 遍历所有地块，累加各商品数量到全局库存

### 库存查询功能

- 获取单个地块的库存汇总
- 获取所有地块的库存汇总列表
- 获取全局库存汇总
- 获取指定地块的商品列表
- 获取全局库存的商品列表

### 状态管理功能

- 支持更新内部state引用
- 确保操作的是最新的游戏状态

---

## 与现有系统的集成

### 与生产系统集成

- 生产建筑产出通过StorageManager存入地块库存
- 生产建筑消耗从地块库存读取原料
- 生产计算完成后自动更新地块库存

### 与市场系统集成

- 市场购买操作使用StorageManager添加商品到全局库存
- 市场出售操作使用StorageManager从全局库存移除商品
- 购买前检查全局库存是否充足

### 与Reducer集成

- addTileStorageReducer 使用StorageManager添加地块库存
- removeTileStorageReducer 使用StorageManager移除地块库存
- addGlobalStorageReducer 使用StorageManager添加全局库存
- removeGlobalStorageReducer 使用StorageManager移除全局库存

---

## 扩展性设计

### 预留扩展点

1. **地块间运输**（未实现）
   - 预留transferGoodsBetweenTiles接口
   - 支持指定源地块和目标地块
   - 检查运输能力和距离限制
   - 计算运输时间和成本

2. **库存容量限制**（未实现）
   - 预留getStorageCapacity和isStorageFull接口
   - 支持设置地块库存容量
   - 添加商品前检查容量限制

3. **库存过期/腐烂**（未实现）
   - 预留updateStorageDecay接口
   - 支持商品过期时间设置
   - 定期更新库存状态

4. **库存锁定**（未实现）
   - 预留lockGoods和unlockGoods接口
   - 支持订单预占库存
   - 防止并发操作冲突

---

## 测试要求

### 库存系统测试

- [ ] 测试地块库存获取
- [ ] 测试地块商品数量获取
- [ ] 测试地块库存充足性检查
- [ ] 测试地块库存添加
- [ ] 测试地块库存移除
- [ ] 测试地块库存设置
- [ ] 测试地块库存清空
- [ ] 测试地块库存汇总获取
- [ ] 测试地块商品列表获取
- [ ] 测试全局库存获取
- [ ] 测试全局商品数量获取
- [ ] 测试全局库存充足性检查
- [ ] 测试全局库存添加
- [ ] 测试全局库存移除
- [ ] 测试全局库存设置
- [ ] 测试全局库存清空
- [ ] 测试全局库存汇总获取
- [ ] 测试全局商品列表获取
- [ ] 测试商品从地块转移到全局
- [ ] 测试转移失败情况（库存不足）
- [ ] 测试全局库存从地块同步
- [ ] 测试获取所有地块库存汇总
- [ ] 测试状态引用更新
- [ ] 测试边界条件（负数、零、非存在地块）
- [ ] 测试超额移除自动限制

### 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试
- 所有边界情况必须有测试

---

## 实现文件

在 packages/core/src/systems/storage/ 目录下创建以下文件：
- storageManager.ts - 库存管理器
- index.ts - 导出文件

---

## 测试文件

创建以下测试文件：
- packages/core/src/systems/storage/__tests__/storageManager.test.ts

---

## 测试运行

运行单元测试命令：cd packages/core && pnpm test

运行覆盖率测试：cd packages/core && pnpm test:coverage

---

## 完成标准

### 功能实现完成

- [ ] StorageManager库存管理器实现完整
- [ ] 地块库存操作接口实现完整
- [ ] 全局库存操作接口实现完整
- [ ] 库存查询与汇总功能实现完整

### 集成完成

- [ ] Reducers已使用StorageManager
- [ ] 与生产系统集成完成
- [ ] 与市场系统集成完成

### 文件创建完成

- [ ] storageManager.ts 创建完成
- [ ] index.ts 创建完成

### 测试完成

- [ ] 所有单元测试通过
- [ ] 测试覆盖率 > 80%
- [ ] 所有公共函数/方法有测试

### 代码检查完成

- [ ] pnpm typecheck 通过
- [ ] pnpm lint 通过
- [ ] 无TypeScript错误
- [ ] 无ESLint错误

---

## 进入下一阶段条件

✅ 所有任务清单完成
✅ 所有功能实现完整
✅ 所有单元测试通过
✅ 测试覆盖率 > 80%
✅ TypeScript类型检查通过
✅ ESLint代码检查通过

---

## 下一步

完成阶段4.1.1后，可以继续执行：
- 阶段4.1的其他子阶段
- 阶段4.2-市场与价格系统

**重要提醒：** 确保所有测试通过且覆盖率达标后再进入下一阶段！
