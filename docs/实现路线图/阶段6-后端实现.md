# 阶段6：后端实现

## 目标

实现后端API服务，提供数据持久化和用户管理。

**重要提示：**
- 本文档只包含接口定义和功能要求，不包含详细代码实现
- 完成后必须进行单元测试
- 测试覆盖率 > 80% 才能进入下一阶段

---

## 任务清单

- [ ] 搭建Fastify服务器
- [ ] 实现用户认证
- [ ] 实现存档API
- [ ] 实现自动保存
- [ ] 实现数据库模型
- [ ] 配置MongoDB
- [ ] 实现API文档
- [ ] 编写单元测试

---

## 1. 搭建Fastify服务器

### 1.1 接口定义要求

**Config接口：**
```typescript
interface Config {
  port: number
  host: string
  mongoUri: string
  jwtSecret: string
  autoSaveInterval: number
}
```

**ServerOptions接口：**
```typescript
interface ServerOptions {
  logger: boolean
  bodyLimit: number
  requestTimeout: number
}
```

### 1.2 功能要求

**服务器配置：**
- 支持环境变量配置
- 支持端口配置
- 支持主机配置
- 支持JWT密钥配置
- 支持自动保存间隔配置

**服务器功能：**
- 启动Fastify服务器
- 配置CORS
- 配置JSON body parser
- 配置路由
- 配置错误处理
- 配置日志系统

**健康检查：**
- GET /health 端点
- 返回服务器状态
- 返回数据库连接状态

### 1.3 测试要求

**服务器测试：**
- [ ] 测试服务器启动
- [ ] 测试健康检查端点
- [ ] 测试CORS配置
- [ ] 测试错误处理

### 1.4 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 2. 用户认证

### 2.1 接口定义要求

**User接口：**
```typescript
interface User {
  _id: string
  username: string
  email: string
  passwordHash: string
  createdAt: Date
  updatedAt: Date
}
```

**AuthPayload接口：**
```typescript
interface AuthPayload {
  userId: string
  username: string
}
```

**RegisterRequest接口：**
```typescript
interface RegisterRequest {
  username: string
  email: string
  password: string
}
```

**LoginRequest接口：**
```typescript
interface LoginRequest {
  email: string
  password: string
}
```

**AuthResponse接口：**
```typescript
interface AuthResponse {
  token: string
  user: {
    id: string
    username: string
    email: string
  }
}
```

### 2.2 功能要求

**用户注册：**
- POST /api/auth/register
- 验证用户名格式
- 验证邮箱格式
- 验证密码强度
- 检查用户名是否已存在
- 检查邮箱是否已存在
- 哈希密码存储
- 返回JWT token

**用户登录：**
- POST /api/auth/login
- 验证邮箱存在
- 验证密码正确
- 生成JWT token
- 返回token和用户信息

**JWT验证：**
- 验证token有效性
- 验证token过期时间
- 解析用户信息
- 返回认证用户

**密码哈希：**
- 使用bcrypt哈希密码
- 哈希强度可配置
- 验证密码匹配

### 2.3 测试要求

**认证测试：**
- [ ] 测试用户注册
- [ ] 测试用户登录
- [ ] 测试JWT验证
- [ ] 测试密码哈希
- [ ] 测试重复注册错误
- [ ] 测试错误凭证

### 2.4 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 3. 存档API

### 3.1 接口定义要求

**SaveGame接口：**
```typescript
interface SaveGame {
  _id: string
  userId: string
  name: string
  data: string
  timestamp: Date
  version: string
  isAutoSave: boolean
}
```

**CreateSaveRequest接口：**
```typescript
interface CreateSaveRequest {
  name: string
  data: string
  version: string
}
```

**UpdateSaveRequest接口：**
```typescript
interface UpdateSaveRequest {
  name?: string
  data?: string
}
```

**SaveListResponse接口：**
```typescript
interface SaveListResponse {
  saves: SaveGame[]
  total: number
}
```

### 3.2 功能要求

**创建存档：**
- POST /api/saves
- 验证用户认证
- 验证存档数据格式
- 存储到数据库
- 返回存档信息

**获取存档列表：**
- GET /api/saves
- 验证用户认证
- 只返回用户自己的存档
- 支持分页
- 支持排序
- 支持筛选

**获取单个存档：**
- GET /api/saves/:id
- 验证用户认证
- 验证存档所有权
- 返回存档数据

**更新存档：**
- PUT /api/saves/:id
- 验证用户认证
- 验证存档所有权
- 更新存档信息
- 返回更新后的存档

**删除存档：**
- DELETE /api/saves/:id
- 验证用户认证
- 验证存档所有权
- 删除存档
- 返回成功状态

**导出存档：**
- GET /api/saves/:id/export
- 验证用户认证
- 验证存档所有权
- 返回存档文件
- 设置正确的Content-Type

**导入存档：**
- POST /api/saves/import
- 验证用户认证
- 验证文件格式
- 解析存档数据
- 创建新存档
- 返回存档信息

### 3.3 测试要求

**存档API测试：**
- [ ] 测试创建存档
- [ ] 测试获取存档列表
- [ ] 测试获取单个存档
- [ ] 测试更新存档
- [ ] 测试删除存档
- [ ] 测试导出存档
- [ ] 测试导入存档
- [ ] 测试权限验证

### 3.4 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 4. 自动保存

### 4.1 接口定义要求

**AutoSaveConfig接口：**
```typescript
interface AutoSaveConfig {
  enabled: boolean
  interval: number
  maxSaves: number
  namePrefix: string
}
```

**AutoSaveTask接口：**
```typescript
interface AutoSaveTask {
  id: string
  intervalId: NodeJS.Timeout
  lastRun: Date
  nextRun: Date
}
```

### 4.2 功能要求

**自动保存功能：**
- 定时执行保存
- 可配置保存间隔
- 可配置最大存档数
- 自动清理旧存档
- 保存失败重试
- 记录保存日志

**自动保存管理：**
- 启动自动保存
- 停止自动保存
- 更新配置
- 查看保存历史

### 4.3 测试要求

**自动保存测试：**
- [ ] 测试自动保存启动
- [ ] 测试自动保存停止
- [ ] 测试配置更新
- [ ] 测试旧存档清理
- [ ] 测试保存失败重试

### 4.4 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 5. 数据库模型

### 5.1 接口定义要求

**UserDocument接口：**
```typescript
interface UserDocument {
  _id: string
  username: string
  email: string
  passwordHash: string
  createdAt: Date
  updatedAt: Date
}
```

**SaveGameDocument接口：**
```typescript
interface SaveGameDocument {
  _id: string
  userId: string
  name: string
  data: string
  timestamp: Date
  version: string
  isAutoSave: boolean
}
```

### 5.2 功能要求

**用户模型：**
- 创建用户
- 查找用户（按ID、用户名、邮箱）
- 更新用户
- 删除用户
- 验证密码

**存档模型：**
- 创建存档
- 查找存档（按ID、用户ID）
- 更新存档
- 删除存档
- 获取用户存档列表
- 删除旧存档

### 5.3 测试要求

**数据库模型测试：**
- [ ] 测试用户CRUD操作
- [ ] 测试存档CRUD操作
- [ ] 测试查询功能
- [ ] 测试事务操作

### 5.4 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 6. MongoDB配置

### 6.1 接口定义要求

**MongoConfig接口：**
```typescript
interface MongoConfig {
  uri: string
  database: string
  options: {
    maxPoolSize: number
    minPoolSize: number
    serverSelectionTimeoutMS: number
    socketTimeoutMS: number
  }
}
```

### 6.2 功能要求

**数据库连接：**
- 连接到MongoDB
- 处理连接错误
- 连接池管理
- 连接重试机制

**数据库操作：**
- 获取数据库实例
- 创建索引
- 数据备份
- 数据迁移

### 6.3 测试要求

**MongoDB测试：**
- [ ] 测试数据库连接
- [ ] 测试连接池管理
- [ ] 测试错误处理
- [ ] 测试重试机制

### 6.4 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 7. API文档

### 7.1 接口定义要求

**ApiDoc接口：**
```typescript
interface ApiDoc {
  openapi: string
  info: {
    title: string
    version: string
    description: string
  }
  servers: Array<{
    url: string
    description: string
  }>
  paths: Record<string, any>
  components: {
    schemas: Record<string, any>
    securitySchemes: Record<string, any>
  }
}
```

### 7.2 功能要求

**OpenAPI文档：**
- 自动生成API文档
- 描述所有端点
- 定义请求/响应schema
- 定义认证方式
- 提供交互式文档（Swagger UI）

**API端点文档：**
- 认证API文档
- 存档API文档
- 健康检查API文档

### 7.3 测试要求

**API文档测试：**
- [ ] 测试文档生成
- [ ] 测试Schema验证
- [ ] 测试Swagger UI访问

### 7.4 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 8. 中间件

### 8.1 接口定义要求

**AuthMiddleware接口：**
```typescript
interface AuthMiddleware {
  (request: any, reply: any): Promise<void>
}
```

**ErrorHandlerMiddleware接口：**
```typescript
interface ErrorHandlerMiddleware {
  (error: any, request: any, reply: any): void
}
```

**RateLimiterMiddleware接口：**
```typescript
interface RateLimiterMiddleware {
  (request: any, reply: any): Promise<void>
}
```

### 8.2 功能要求

**认证中间件：**
- 验证JWT token
- 提取用户信息
- 添加到请求上下文

**错误处理中间件：**
- 捕获所有错误
- 格式化错误响应
- 记录错误日志
- 处理不同错误类型

**限流中间件：**
- 基于IP限流
- 基于用户限流
- 可配置限流规则
- 返回限流信息

**日志中间件：**
- 记录所有请求
- 记录响应时间
- 记录请求体
- 记录响应体

### 8.3 测试要求

**中间件测试：**
- [ ] 测试认证中间件
- [ ] 测试错误处理中间件
- [ ] 测试限流中间件
- [ ] 测试日志中间件

### 8.4 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 9. 创建导出文件

### 9.1 创建服务器导出文件

在 `apps/server/src/` 创建 `index.ts`

**导出内容：**
- config/ 目录中的所有内容
- db/ 目录中的所有内容
- routes/ 目录中的所有内容
- middleware/ 目录中的所有内容
- models/ 目录中的所有内容
- services/ 目录中的所有内容

### 9.2 创建API导出文件

在 `apps/server/src/routes/` 创建 `index.ts`

**导出内容：**
- auth/ 目录中的所有路由
- saves/ 目录中的所有路由
- health.ts 路由

---

## 10. 编写单元测试

### 10.1 创建测试文件

创建以下测试文件：
- `apps/server/src/__tests__/server.test.ts`
- `apps/server/src/routes/__tests__/auth.test.ts`
- `apps/server/src/routes/__tests__/saves.test.ts`
- `apps/server/src/middleware/__tests__/auth.test.ts`
- `apps/server/src/middleware/__tests__/errorHandler.test.ts`
- `apps/server/src/services/__tests__/authService.test.ts`
- `apps/server/src/services/__tests__/saveService.test.ts`
- `apps/server/src/models/__tests__/user.test.ts`
- `apps/server/src/models/__tests__/saveGame.test.ts`

### 10.2 测试运行

```bash
cd apps/server
pnpm test
```

### 10.3 测试覆盖率

```bash
cd apps/server
pnpm test:coverage
```

---

## 完成标准

### 功能实现完成

- [ ] Fastify服务器搭建完成
- [ ] 用户认证实现完整
- [ ] 存档API实现完整
- [ ] 自动保存实现完整
- [ ] 数据库模型实现完整
- [ ] MongoDB配置完成
- [ ] API文档实现完整

### 文件创建完成

- [ ] server.ts 创建完成
- [ ] config/index.ts 创建完成
- [ ] db/index.ts 创建完成
- [ ] routes/auth/index.ts 创建完成
- [ ] routes/saves/index.ts 创建完成
- [ ] middleware/auth.ts 创建完成
- [ ] middleware/errorHandler.ts 创建完成
- [ ] models/user.ts 创建完成
- [ ] models/saveGame.ts 创建完成
- [ ] services/authService.ts 创建完成
- [ ] services/saveService.ts 创建完成
- [ ] 所有导出文件创建完成

### 测试完成

- [ ] 所有单元测试通过
- [ ] 测试覆盖率 > 80%
- [ ] 所有公共函数/方法有测试

### 代码检查完成

- [ ] `pnpm typecheck` 通过
- [ ] `pnpm lint` 通过
- [ ] 无TypeScript错误
- [ ] 无ESLint错误

---

## 进入下一阶段条件

✅ 所有任务清单完成
✅ 所有后端功能实现完整
✅ 所有单元测试通过
✅ 测试覆盖率 > 80%
✅ TypeScript类型检查通过
✅ ESLint代码检查通过

---

## 项目完成

恭喜！所有阶段已经完成！

### 最终检查清单

- [ ] 所有6个阶段完成
- [ ] 所有测试通过
- [ ] 所有测试覆盖率达标
- [ ] 所有代码检查通过
- [ ] 文档完整

### 下一步建议

- [ ] 进行集成测试
- [ ] 进行端到端测试
- [ ] 性能优化
- [ ] 部署到生产环境
- [ ] 收集用户反馈
- [ ] 持续迭代改进

**重要提醒：** 确保所有测试通过且覆盖率达标后再部署到生产环境！
