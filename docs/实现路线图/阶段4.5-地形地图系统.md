# 阶段4.5：地形地图系统

## 目标

实现地块生成、地形系统、资源矿床、领土扩张、地块开发度和地图探索。

**重要提示：**
- 本文档只包含接口定义和功能要求，不包含详细代码实现
- 完成后必须进行单元测试
- 测试覆盖率 > 80% 才能进入下一阶段

---

## 任务清单

- [ ] 实现地块生成
- [ ] 实现地形系统
- [ ] 实现资源矿床
- [ ] 实现领土扩张
- [ ] 实现地块开发度
- [ ] 实现地图探索

---

## 接口定义要求

### ITileManager接口

```typescript
interface ITileManager {
  generateInitialTile(): Tile
  generateNewTile(terrainType: string): Tile
  exploreTile(tileId: string): boolean
  controlTile(tileId: string): boolean
  getTile(id: string): Tile | undefined
  getAllTiles(): Tile[]
  getAdjacentTiles(tileId: string): Tile[]
  developTile(tileId: string): void
}
```

### ITerrainGenerator接口

```typescript
interface ITerrainGenerator {
  generateTerrain(): Map<TerrainType, number>
  generateResourceDeposits(terrain: Map<TerrainType, number>): ResourceDeposit[]
}
```

---

## 功能要求

### 地块生成功能

- 生成初始地块
- 生成新地块
- 生成地形组成
- 生成资源矿床

### 地块管理功能

- 探索地块
- 控制地块
- 获取地块信息
- 获取相邻地块

### 地块开发功能

- 增加开发度
- 计算开发经验
- 解开开发加成

### 资源矿床功能

- 发现资源
- 开采资源
- 资源枯竭

---

## 测试要求

### 地块系统测试

- [ ] 测试地块生成
- [ ] 测试地形组成
- [ ] 测试资源生成
- [ ] 测试地块探索
- [ ] 测试地块控制
- [ ] 测试可建设面积计算
- [ ] 测试资源开采

### 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 实现文件

在 `packages/core/src/systems/terrain/` 目录下创建以下文件：

- `tileManager.ts` - 地块管理器
- `terrainGenerator.ts` - 地形生成器
- `index.ts` - 导出文件

---

## 测试文件

创建以下测试文件：

- `packages/core/src/systems/terrain/__tests__/tileManager.test.ts`
- `packages/core/src/systems/terrain/__tests__/terrainGenerator.test.ts`

---

## 测试运行

```bash
cd packages/core
pnpm test
```

### 测试覆盖率

```bash
cd packages/core
pnpm test:coverage
```

---

## 完成标准

### 功能实现完成

- [ ] 地块生成功能实现完整
- [ ] 地块管理功能实现完整
- [ ] 地块开发功能实现完整
- [ ] 资源矿床功能实现完整

### 文件创建完成

- [ ] tileManager.ts 创建完成
- [ ] terrainGenerator.ts 创建完成
- [ ] index.ts 创建完成

### 测试完成

- [ ] 所有单元测试通过
- [ ] 测试覆盖率 > 80%
- [ ] 所有公共函数/方法有测试

### 代码检查完成

- [ ] `pnpm typecheck` 通过
- [ ] `pnpm lint` 通过
- [ ] 无TypeScript错误
- [ ] 无ESLint错误

---

## 进入下一阶段条件

✅ 所有任务清单完成
✅ 所有功能实现完整
✅ 所有单元测试通过
✅ 测试覆盖率 > 80%
✅ TypeScript类型检查通过
✅ ESLint代码检查通过

---

## 下一步

完成阶段4.5后，继续执行[阶段4.6-运输系统](./阶段4.6-运输系统.md)

**重要提醒：** 确保所有测试通过且覆盖率达标后再进入下一阶段！
