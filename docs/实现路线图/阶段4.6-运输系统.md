# 阶段4.6：运输系统

## 目标

实现运力计算、道路系统、运力需求、运力不足影响、运输工具演进和运力管理。

**重要提示：**
- 本文档只包含接口定义和功能要求，不包含详细代码实现
- 完成后必须进行单元测试
- 测试覆盖率 > 80% 才能进入下一阶段

---

## 任务清单

- [ ] 实现运力计算
- [ ] 实现道路系统
- [ ] 实现运力需求
- [ ] 实现运力不足影响
- [ ] 实现运输工具演进
- [ ] 实现运力管理

---

## 接口定义要求

### ITransportManager接口

```typescript
interface ITransportManager {
  updateTransportCapacity(tileId: string, buildings: Building[]): void
  calculateEfficiencyPenalties(tileId: string): Map<string, number>
  upgradeRoad(tileId: string): void
  getCapacity(tileId: string): TileTransportCapacity | undefined
  allocateCapacity(tileId: string, goods: Map<string, number>): void
}
```

### ITransportCalculator接口

```typescript
interface ITransportCalculator {
  calculateCapacity(roadLevel: number, era: Era): number
  calculateDemand(buildings: Building[]): Map<string, number>
  calculateEfficiency(
    capacity: number,
    demand: number
  ): number
}
```

---

## 功能要求

### 运力计算功能

- 基于道路等级计算运力
- 基于时代计算运力加成
- 计算运输需求
- 计算运输效率

### 道路管理功能

- 升级道路
- 计算升级成本
- 解锁新的运输方式

### 运力分配功能

- 按优先级分配运力
- 计算运力不足惩罚
- 优先保证必需品运输

---

## 测试要求

### 运输系统测试

- [ ] 测试运力计算
- [ ] 测试道路升级
- [ ] 测试运力需求计算
- [ ] 测试效率惩罚
- [ ] 测试优先级分配
- [ ] 测试运输工具演进

### 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 实现文件

在 `packages/core/src/systems/transport/` 目录下创建以下文件：

- `transportManager.ts` - 运输管理器
- `transportCalculator.ts` - 运输计算器
- `index.ts` - 导出文件

---

## 测试文件

创建以下测试文件：

- `packages/core/src/systems/transport/__tests__/transportManager.test.ts`
- `packages/core/src/systems/transport/__tests__/transportCalculator.test.ts`

---

## 测试运行

```bash
cd packages/core
pnpm test
```

### 测试覆盖率

```bash
cd packages/core
pnpm test:coverage
```

---

## 完成标准

### 功能实现完成

- [ ] 运力计算功能实现完整
- [ ] 道路管理功能实现完整
- [ ] 运力分配功能实现完整

### 文件创建完成

- [ ] transportManager.ts 创建完成
- [ ] transportCalculator.ts 创建完成
- [ ] index.ts 创建完成

### 测试完成

- [ ] 所有单元测试通过
- [ ] 测试覆盖率 > 80%
- [ ] 所有公共函数/方法有测试

### 代码检查完成

- [ ] `pnpm typecheck` 通过
- [ ] `pnpm lint` 通过
- [ ] 无TypeScript错误
- [ ] 无ESLint错误

---

## 进入下一阶段条件

✅ 所有任务清单完成
✅ 所有功能实现完整
✅ 所有单元测试通过
✅ 测试覆盖率 > 80%
✅ TypeScript类型检查通过
✅ ESLint代码检查通过

---

## 下一步

完成阶段4.6后，所有阶段4子系统已完成，可以继续执行[阶段5-UI层实现](./阶段5-UI层实现.md)

**重要提醒：** 确保所有测试通过且覆盖率达标后再进入下一阶段！
