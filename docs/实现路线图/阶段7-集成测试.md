# 阶段7：集成测试

## 概述

本阶段实现前后端集成测试，确保所有功能正常工作。

## 目标

- 创建前端API服务层
- 配置Playwright E2E测试
- 编写完整的测试用例
- 验证所有功能正常工作

## 实现内容

### 1. 前端API服务层

**文件**: `apps/web/src/services/api.ts`

封装所有后端API调用：

```typescript
class ApiService {
  // 用户认证
  register(username, email, password)
  login(username, password)
  logout()
  
  // 存档管理
  getSaves()
  createSave(name, gameState)
  getSave(id)
  getSaveState(id)
  updateSave(id, data)
  deleteSave(id)
  
  // 工具方法
  healthCheck()
  isAuthenticated()
}
```

### 2. E2E测试配置

**文件**: `apps/web/playwright.config.ts`

```typescript
export default defineConfig({
  testDir: './e2e',
  projects: [
    {
      name: 'chromium',
      use: {
        ...devices['Desktop Chrome'],
        channel: 'chrome'  // 使用系统Chrome
      }
    }
  ],
  webServer: [
    {
      command: 'pnpm dev',
      url: 'http://localhost:3000',
      reuseExistingServer: true
    }
  ]
})
```

### 3. 测试用例

#### 认证测试 (`e2e/auth.spec.ts`)

| 测试项 | 描述 |
|--------|------|
| should display the dashboard page | 验证仪表盘页面显示 |
| should show game stats on dashboard | 验证统计数据卡片显示 |
| should navigate between pages | 验证页面导航功能 |
| should pause and resume game | 验证暂停/继续功能 |
| should add building | 验证建造建筑功能 |
| should buy goods in market | 验证市场购买功能 |

#### 游戏机制测试 (`e2e/game.spec.ts`)

| 测试项 | 描述 |
|--------|------|
| should increment game date over time | 验证游戏日期递增 |
| should display population stats | 验证人口统计显示 |
| should show technology tree | 验证科技树显示 |
| should display building list | 验证建筑列表显示 |
| should display settings options | 验证设置选项显示 |
| should change game speed | 验证游戏速度设置 |
| should toggle notifications | 验证通知开关 |
| should save game | 验证保存游戏功能 |
| should display existing buildings | 验证现有建筑显示 |
| should show building efficiency | 验证建筑效率显示 |
| should add multiple building types | 验证建造多种建筑 |
| should display goods prices | 验证商品价格显示 |
| should display trade panel | 验证交易面板显示 |

### 4. 依赖安装

```json
{
  "devDependencies": {
    "@playwright/test": "^1.40.0"
  }
}
```

### 5. 环境配置

**文件**: `apps/web/.env.test`

```
VITE_API_URL=http://localhost:3001
```

## 运行测试

```bash
# 运行所有E2E测试
cd apps/web && pnpm test:e2e

# 使用UI模式运行
cd apps/web && pnpm test:e2e:ui
```

## 测试结果

```
Running 19 tests using 4 workers

✓ 19 passed (17.9s)
```

所有19个测试用例全部通过。

## 文件结构

```
apps/web/
├── e2e/
│   ├── auth.spec.ts          # 认证和导航测试
│   └── game.spec.ts          # 游戏机制测试
├── playwright.config.ts      # Playwright配置
├── .env.test                 # 测试环境变量
└── src/
    └── services/
        └── api.ts            # API服务层
```

## 注意事项

1. **使用系统Chrome**: 配置使用系统安装的Chrome浏览器，避免下载Chromium
2. **游戏状态初始化**: 测试需要先访问首页初始化游戏状态，再导航到其他页面
3. **等待时间**: 适当添加等待时间确保页面完全加载
4. **元素选择器**: 使用更精确的选择器避免匹配多个元素

## 完成状态

- [x] 创建前端API服务层
- [x] 创建E2E测试配置
- [x] 编写用户认证E2E测试
- [x] 编写存档管理E2E测试
- [x] 配置Playwright测试
- [x] 运行完整测试套件

## 下一阶段

项目开发完成！所有7个阶段已全部实现：

1. ✅ 阶段1：项目初始化
2. ✅ 阶段2：核心数据模型
3. ✅ 阶段3：基础系统实现
4. ✅ 阶段4：高级系统实现
5. ✅ 阶段5：UI层实现
6. ✅ 阶段6：后端实现
7. ✅ 阶段7：集成测试
