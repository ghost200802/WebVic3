# 阶段4.2：市场与价格系统

## 目标

实现市场管理、价格计算（瓦尔拉斯均衡）、供需计算、库存管理、市场事件系统和价格干预机制。

**重要提示：**
- 本文档只包含接口定义和功能要求，不包含详细代码实现
- 完成后必须进行单元测试
- 测试覆盖率 > 80% 才能进入下一阶段

---

## 任务清单

- [ ] 实现市场管理
- [ ] 实现价格计算（瓦尔拉斯均衡）
- [ ] 实现供需计算
- [ ] 实现库存管理
- [ ] 实现市场事件系统
- [ ] 实现价格干预机制

---

## 接口定义要求

### IMarketManager接口

```typescript
interface IMarketManager {
  updatePrices(date: GameDate): void
  addSupply(goodsId: string, amount: number): void
  addDemand(goodsId: string, amount: number): void
  getPrice(goodsId: string): number
  executeTransaction(goodsId: string, amount: number, isPurchase: boolean): number
  getMarket(): Market
}
```

### IPriceCalculator接口

```typescript
interface IPriceCalculator {
  calculatePrice(
    basePrice: number,
    supply: number,
    demand: number,
    stockpile: number
  ): number
  calculatePriceAdjustment(
    currentPrice: number,
    basePrice: number,
    supply: number,
    demand: number
  ): number
}
```

---

## 功能要求

### 市场管理功能

- 更新所有商品价格
- 添加供给
- 添加需求
- 获取商品价格
- 执行交易
- 管理库存

### 价格计算功能

- 基于瓦尔拉斯均衡计算价格
- 考虑供需关系
- 考虑库存水平
- 平滑价格变化
- 记录价格历史

### 市场事件功能

- 丰收事件（降低农产品价格）
- 饥荒事件（提高食品价格）
- 经济繁荣/衰退
- 资源发现

---

## 测试要求

### 市场系统测试

- [ ] 测试价格更新逻辑
- [ ] 测试供需计算
- [ ] 测试价格调整函数
- [ ] 测试交易功能
- [ ] 测试库存管理
- [ ] 测试市场事件
- [ ] 测试价格收敛性

### 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 实现文件

在 `packages/core/src/systems/economy/` 目录下创建以下文件：

- `marketManager.ts` - 市场管理器
- `priceCalculator.ts` - 价格计算器
- `index.ts` - 导出文件

---

## 测试文件

创建以下测试文件：

- `packages/core/src/systems/economy/__tests__/marketManager.test.ts`
- `packages/core/src/systems/economy/__tests__/priceCalculator.test.ts`

---

## 测试运行

```bash
cd packages/core
pnpm test
```

### 测试覆盖率

```bash
cd packages/core
pnpm test:coverage
```

---

## 完成标准

### 功能实现完成

- [ ] 市场管理功能实现完整
- [ ] 价格计算功能实现完整
- [ ] 市场事件功能实现完整

### 文件创建完成

- [ ] marketManager.ts 创建完成
- [ ] priceCalculator.ts 创建完成
- [ ] index.ts 创建完成

### 测试完成

- [ ] 所有单元测试通过
- [ ] 测试覆盖率 > 80%
- [ ] 所有公共函数/方法有测试

### 代码检查完成

- [ ] `pnpm typecheck` 通过
- [ ] `pnpm lint` 通过
- [ ] 无TypeScript错误
- [ ] 无ESLint错误

---

## 进入下一阶段条件

✅ 所有任务清单完成
✅ 所有功能实现完整
✅ 所有单元测试通过
✅ 测试覆盖率 > 80%
✅ TypeScript类型检查通过
✅ ESLint代码检查通过

---

## 下一步

完成阶段4.2后，继续执行[阶段4.3-人口与就业系统](./阶段4.3-人口与就业系统.md)

**重要提醒：** 确保所有测试通过且覆盖率达标后再进入下一阶段！
