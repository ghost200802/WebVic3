# 阶段4：高级系统实现

## 目标

实现六大核心游戏系统：生产系统、市场与价格系统、人口与就业系统、科技系统、地形地图系统、运输系统。

**重要提示：**
- 每个子系统都有独立的详细文档
- 完成后必须进行单元测试
- 测试覆盖率 > 80% 才能进入下一阶段

---

## 子系统概览

阶段4被拆分为以下6个独立的子系统，请按顺序依次完成：

### 4.1 生产系统

**文档：** [阶段4.1-生产系统.md](./阶段4.1-生产系统.md)

**核心功能：**
- 建筑管理
- 生产方式选择
- 生产计算
- 生产效率计算
- 资源枯竭机制
- 建筑升级系统

**实现文件：**
- `packages/core/src/systems/production/buildingManager.ts`
- `packages/core/src/systems/production/productionCalculator.ts`

---

### 4.2 市场与价格系统

**文档：** [阶段4.2-市场与价格系统.md](./阶段4.2-市场与价格系统.md)

**核心功能：**
- 市场管理
- 价格计算（瓦尔拉斯均衡）
- 供需计算
- 库存管理
- 市场事件系统
- 价格干预机制

**实现文件：**
- `packages/core/src/systems/economy/marketManager.ts`
- `packages/core/src/systems/economy/priceCalculator.ts`

---

### 4.3 人口与就业系统

**文档：** [阶段4.3-人口与就业系统.md](./阶段4.3-人口与就业系统.md)

**核心功能：**
- 人口管理
- 人口增长模型
- 就业系统
- 工资计算
- 生活水平计算
- 需求满足计算
- 人口流动

**实现文件：**
- `packages/core/src/systems/population/populationManager.ts`
- `packages/core/src/systems/population/wageCalculator.ts`
- `packages/core/src/systems/population/livingStandardCalculator.ts`

---

### 4.4 科技系统

**文档：** [阶段4.4-科技系统.md](./阶段4.4-科技系统.md)

**核心功能：**
- 科技树
- 研发系统
- 科技解锁机制
- 科技扩散
- 时代晋升系统
- 研发机构

**实现文件：**
- `packages/core/src/systems/technology/technologyManager.ts`
- `packages/core/src/systems/technology/researchCalculator.ts`

---

### 4.5 地形地图系统

**文档：** [阶段4.5-地形地图系统.md](./阶段4.5-地形地图系统.md)

**核心功能：**
- 地块生成
- 地形系统
- 资源矿床
- 领土扩张
- 地块开发度
- 地图探索

**实现文件：**
- `packages/core/src/systems/terrain/tileManager.ts`
- `packages/core/src/systems/terrain/terrainGenerator.ts`

---

### 4.6 运输系统

**文档：** [阶段4.6-运输系统.md](./阶段4.6-运输系统.md)

**核心功能：**
- 运力计算
- 道路系统
- 运力需求
- 运力不足影响
- 运输工具演进
- 运力管理

**实现文件：**
- `packages/core/src/systems/transport/transportManager.ts`
- `packages/core/src/systems/transport/transportCalculator.ts`

---

## 总体任务清单

- [ ] 完成 4.1 生产系统
- [ ] 完成 4.2 市场与价格系统
- [ ] 完成 4.3 人口与就业系统
- [ ] 完成 4.4 科技系统
- [ ] 完成 4.5 地形地图系统
- [ ] 完成 4.6 运输系统
- [ ] 创建系统导出文件

---

## 创建系统导出文件

在 `packages/core/src/systems/` 创建 `index.ts`

**导出内容：**
- production/ 目录中的所有内容
- economy/ 目录中的所有内容（市场系统）
- population/ 目录中的所有内容
- technology/ 目录中的所有内容
- terrain/ 目录中的所有内容
- transport/ 目录中的所有内容

---

## 测试运行

```bash
cd packages/core
pnpm test
```

### 测试覆盖率

```bash
cd packages/core
pnpm test:coverage
```

---

## 完成标准

### 功能实现完成

- [ ] 生产系统实现完整
- [ ] 市场与价格系统实现完整
- [ ] 人口与就业系统实现完整
- [ ] 科技系统实现完整
- [ ] 地形地图系统实现完整
- [ ] 运输系统实现完整

### 测试完成

- [ ] 所有单元测试通过
- [ ] 测试覆盖率 > 80%
- [ ] 所有公共函数/方法有测试

### 代码检查完成

- [ ] `pnpm typecheck` 通过
- [ ] `pnpm lint` 通过
- [ ] 无TypeScript错误
- [ ] 无ESLint错误

---

## 进入下一阶段条件

✅ 所有子系统文档任务完成
✅ 所有系统实现完整
✅ 所有单元测试通过
✅ 测试覆盖率 > 80%
✅ TypeScript类型检查通过
✅ ESLint代码检查通过

---

## 下一步

完成所有子系统后，进入[阶段5-UI层实现](./阶段5-UI层实现.md)

**重要提醒：** 确保所有子系统测试通过且覆盖率达标后再进入下一阶段！
