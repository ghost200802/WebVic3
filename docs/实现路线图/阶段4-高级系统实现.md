# 阶段4：高级系统实现

## 目标

实现六大核心游戏系统：生产系统、市场与价格系统、人口与就业系统、科技系统、地形地图系统、运输系统。

**重要提示：**
- 本文档只包含接口定义和功能要求，不包含详细代码实现
- 完成后必须进行单元测试
- 测试覆盖率 > 80% 才能进入下一阶段

---

## 任务清单

- [ ] 实现生产系统
- [ ] 实现市场与价格系统
- [ ] 实现人口与就业系统
- [ ] 实现科技系统
- [ ] 实现地形地图系统
- [ ] 实现运输系统
- [ ] 编写单元测试

---

## 4.1 生产系统

### 任务清单

- [ ] 实现建筑管理
- [ ] 实现生产方式选择
- [ ] 实现生产计算
- [ ] 实现生产效率计算
- [ ] 实现资源枯竭机制
- [ ] 实现建筑升级系统

### 4.1.1 接口定义要求

**IBuildingManager接口：**
```typescript
interface IBuildingManager {
  createBuilding(configKey: string, tileId: string): Building
  getBuilding(id: string): Building | undefined
  getAllBuildings(): Building[]
  getBuildingsByTile(tileId: string): Building[]
  upgradeBuilding(buildingId: string): void
  removeBuilding(buildingId: string): void
  setProductionMethod(buildingId: string, methodId: string): void
}
```

**IProductionCalculator接口：**
```typescript
interface IProductionCalculator {
  calculateProduction(
    building: Building,
    workers: number,
    era: Era,
    educationLevel: number,
    toolAvailability: number
  ): ProductionResult
  calculateUpgradeCost(building: Building): Record<string, number>
}
```

**ProductionResult接口：**
```typescript
interface ProductionResult {
  inputs: Map<string, number>
  outputs: Map<string, number>
  efficiency: number
}
```

### 4.1.2 功能要求

**建筑管理功能：**
- 创建建筑（根据配置）
- 获取单个建筑
- 获取所有建筑
- 获取地块上的建筑
- 升级建筑
- 删除建筑
- 切换生产方式

**生产计算功能：**
- 根据工人数量计算产出
- 考虑时代加成
- 考虑教育水平
- 考虑工具可用性
- 计算输入/产出
- 计算生产效率

**建筑升级功能：**
- 计算升级成本
- 提升建筑等级
- 增加建筑经验
- 解锁新的生产方式

### 4.1.3 测试要求

**生产系统测试：**
- [ ] 测试建筑创建
- [ ] 测试建筑升级
- [ ] 测试生产方式切换
- [ ] 测试生产计算
- [ ] 测试效率计算
- [ ] 测试资源枯竭
- [ ] 测试边界条件（最大工人、最小工人等）

### 4.1.4 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 4.2 市场与价格系统

### 任务清单

- [ ] 实现市场管理
- [ ] 实现价格计算（瓦尔拉斯均衡）
- [ ] 实现供需计算
- [ ] 实现库存管理
- [ ] 实现市场事件系统
- [ ] 实现价格干预机制

### 4.2.1 接口定义要求

**IMarketManager接口：**
```typescript
interface IMarketManager {
  updatePrices(date: GameDate): void
  addSupply(goodsId: string, amount: number): void
  addDemand(goodsId: string, amount: number): void
  getPrice(goodsId: string): number
  executeTransaction(goodsId: string, amount: number, isPurchase: boolean): number
  getMarket(): Market
}
```

**IPriceCalculator接口：**
```typescript
interface IPriceCalculator {
  calculatePrice(
    basePrice: number,
    supply: number,
    demand: number,
    stockpile: number
  ): number
  calculatePriceAdjustment(
    currentPrice: number,
    basePrice: number,
    supply: number,
    demand: number
  ): number
}
```

### 4.2.2 功能要求

**市场管理功能：**
- 更新所有商品价格
- 添加供给
- 添加需求
- 获取商品价格
- 执行交易
- 管理库存

**价格计算功能：**
- 基于瓦尔拉斯均衡计算价格
- 考虑供需关系
- 考虑库存水平
- 平滑价格变化
- 记录价格历史

**市场事件功能：**
- 丰收事件（降低农产品价格）
- 饥荒事件（提高食品价格）
- 经济繁荣/衰退
- 资源发现

### 4.2.3 测试要求

**市场系统测试：**
- [ ] 测试价格更新逻辑
- [ ] 测试供需计算
- [ ] 测试价格调整函数
- [ ] 测试交易功能
- [ ] 测试库存管理
- [ ] 测试市场事件
- [ ] 测试价格收敛性

### 4.2.4 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 4.3 人口与就业系统

### 任务清单

- [ ] 实现人口管理
- [ ] 实现人口增长模型
- [ ] 实现就业系统
- [ ] 实现工资计算
- [ ] 实现生活水平计算
- [ ] 实现需求满足计算
- [ ] 实现人口流动

### 4.3.1 接口定义要求

**IPopulationManager接口：**
```typescript
interface IPopulationManager {
  updateGrowth(date: GameDate): void
  calculateWages(marketPrices: Map<string, number>): void
  calculateLivingStandards(marketPrices: Map<string, number>): void
  getPopulation(id: string): Population | undefined
  getAllPopulations(): Population[]
  assignWorker(populationId: string, buildingId: string): void
  removeWorker(populationId: string): void
}
```

**IWageCalculator接口：**
```typescript
interface IWageCalculator {
  calculateWage(
    worker: PopulationGroup,
    building: Building,
    marketPrices: Map<string, number>
  ): number
}
```

**ILivingStandardCalculator接口：**
```typescript
interface ILivingStandardCalculator {
  calculateLivingStandard(
    population: PopulationGroup,
    marketPrices: Map<string, number>
  ): number
  calculateNeedSatisfaction(
    population: PopulationGroup,
    marketPrices: Map<string, number>
  ): {
    survival: number
    basic: number
    improved: number
    luxury: number
  }
}
```

### 4.3.2 功能要求

**人口增长模型：**
- 基于生活水平计算出生率
- 基于生活水平计算死亡率
- 考虑年龄分布
- 考虑移民因素

**就业系统：**
- 分配工人到建筑
- 计算失业率
- 管理退休人员
- 处理解雇

**工资计算：**
- 基于建筑类型计算基础工资
- 考虑工人技能
- 考虑教育水平
- 考虑商品价格（实际购买力）

**生活水平计算：**
- 基于工资和物价计算
- 考虑需求满足度
- 生存需求、基本需求、改善需求、奢侈品需求

### 4.3.3 测试要求

**人口系统测试：**
- [ ] 测试人口增长计算
- [ ] 测试出生率和死亡率
- [ ] 测试工资计算
- [ ] 测试生活水平计算
- [ ] 测试需求满足计算
- [ ] 测试人口流动
- [ ] 测试就业分配

### 4.3.4 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 4.4 科技系统

### 任务清单

- [ ] 实现科技树
- [ ] 实现研发系统
- [ ] 实现科技解锁机制
- [ ] 实现科技扩散
- [ ] 实现时代晋升系统
- [ ] 实现研发机构

### 4.4.1 接口定义要求

**ITechnologyManager接口：**
```typescript
interface ITechnologyManager {
  addTechToQueue(techId: string): void
  removeTechFromQueue(techId: string): void
  canResearch(techId: string): boolean
  advanceResearch(days: number): void
  getAvailableTechs(): Technology[]
  getResearchedTechs(): Set<string>
  getResearchQueue(): ResearchQueue
  unlockTech(techId: string): void
}
```

**IResearchCalculator接口：**
```typescript
interface IResearchCalculator {
  calculateResearchSpeed(
    era: Era,
    population: number,
    education: number,
    institutions: string[]
  ): number
  calculateResearchTime(tech: Technology, speed: number): number
}
```

### 4.4.2 功能要求

**科技管理功能：**
- 添加科技到研发队列
- 从队列移除科技
- 检查是否可以研发
- 推进研发进度
- 获取可用科技
- 获取已研发科技
- 解锁科技

**研发计算功能：**
- 基于时代计算基础速度
- 考虑人口规模
- 考虑教育水平
- 考虑研发机构
- 计算研发时间

**科技解锁功能：**
- 检查前置科技
- 检查时代要求
- 检查资源需求
- 解锁建筑
- 解锁生产方式
- 解锁商品

### 4.4.3 测试要求

**科技系统测试：**
- [ ] 测试科技解锁判断
- [ ] 测试研发队列
- [ ] 测试研发进度推进
- [ ] 测试科技完成
- [ ] 测试前置科技验证
- [ ] 测试研发速度计算
- [ ] 测试科技解锁效果

### 4.4.4 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 4.5 地形地图系统

### 任务清单

- [ ] 实现地块生成
- [ ] 实现地形系统
- [ ] 实现资源矿床
- [ ] 实现领土扩张
- [ ] 实现地块开发度
- [ ] 实现地图探索

### 4.5.1 接口定义要求

**ITileManager接口：**
```typescript
interface ITileManager {
  generateInitialTile(): Tile
  generateNewTile(terrainType: string): Tile
  exploreTile(tileId: string): boolean
  controlTile(tileId: string): boolean
  getTile(id: string): Tile | undefined
  getAllTiles(): Tile[]
  getAdjacentTiles(tileId: string): Tile[]
  developTile(tileId: string): void
}
```

**ITerrainGenerator接口：**
```typescript
interface ITerrainGenerator {
  generateTerrain(): Map<TerrainType, number>
  generateResourceDeposits(terrain: Map<TerrainType, number>): ResourceDeposit[]
}
```

### 4.5.2 功能要求

**地块生成功能：**
- 生成初始地块
- 生成新地块
- 生成地形组成
- 生成资源矿床

**地块管理功能：**
- 探索地块
- 控制地块
- 获取地块信息
- 获取相邻地块

**地块开发功能：**
- 增加开发度
- 计算开发经验
- 解开开发加成

**资源矿床功能：**
- 发现资源
- 开采资源
- 资源枯竭

### 4.5.3 测试要求

**地块系统测试：**
- [ ] 测试地块生成
- [ ] 测试地形组成
- [ ] 测试资源生成
- [ ] 测试地块探索
- [ ] 测试地块控制
- [ ] 测试可建设面积计算
- [ ] 测试资源开采

### 4.5.4 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 4.6 运输系统

### 任务清单

- [ ] 实现运力计算
- [ ] 实现道路系统
- [ ] 实现运力需求
- [ ] 实现运力不足影响
- [ ] 实现运输工具演进
- [ ] 实现运力管理

### 4.6.1 接口定义要求

**ITransportManager接口：**
```typescript
interface ITransportManager {
  updateTransportCapacity(tileId: string, buildings: Building[]): void
  calculateEfficiencyPenalties(tileId: string): Map<string, number>
  upgradeRoad(tileId: string): void
  getCapacity(tileId: string): TileTransportCapacity | undefined
  allocateCapacity(tileId: string, goods: Map<string, number>): void
}
```

**ITransportCalculator接口：**
```typescript
interface ITransportCalculator {
  calculateCapacity(roadLevel: number, era: Era): number
  calculateDemand(buildings: Building[]): Map<string, number>
  calculateEfficiency(
    capacity: number,
    demand: number
  ): number
}
```

### 4.6.2 功能要求

**运力计算功能：**
- 基于道路等级计算运力
- 基于时代计算运力加成
- 计算运输需求
- 计算运输效率

**道路管理功能：**
- 升级道路
- 计算升级成本
- 解锁新的运输方式

**运力分配功能：**
- 按优先级分配运力
- 计算运力不足惩罚
- 优先保证必需品运输

### 4.6.3 测试要求

**运输系统测试：**
- [ ] 测试运力计算
- [ ] 测试道路升级
- [ ] 测试运力需求计算
- [ ] 测试效率惩罚
- [ ] 测试优先级分配
- [ ] 测试运输工具演进

### 4.6.4 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 5. 创建导出文件

### 5.1 创建系统导出文件

在 `packages/core/src/systems/` 创建 `index.ts`

**导出内容：**
- production/ 目录中的所有内容
- economy/ 目录中的所有内容（市场系统）
- population/ 目录中的所有内容
- technology/ 目录中的所有内容
- terrain/ 目录中的所有内容
- transport/ 目录中的所有内容

---

## 6. 编写单元测试

### 6.1 创建测试文件

创建以下测试文件：
- `packages/core/src/systems/production/__tests__/buildingManager.test.ts`
- `packages/core/src/systems/production/__tests__/productionCalculator.test.ts`
- `packages/core/src/systems/economy/__tests__/marketManager.test.ts`
- `packages/core/src/systems/population/__tests__/populationManager.test.ts`
- `packages/core/src/systems/technology/__tests__/technologyManager.test.ts`
- `packages/core/src/systems/terrain/__tests__/tileManager.test.ts`
- `packages/core/src/systems/transport/__tests__/transportManager.test.ts`

### 6.2 测试运行

```bash
cd packages/core
pnpm test
```

### 6.3 测试覆盖率

```bash
cd packages/core
pnpm test:coverage
```

---

## 完成标准

### 功能实现完成

- [ ] 生产系统实现完整
- [ ] 市场与价格系统实现完整
- [ ] 人口与就业系统实现完整
- [ ] 科技系统实现完整
- [ ] 地形地图系统实现完整
- [ ] 运输系统实现完整

### 文件创建完成

- [ ] buildingManager.ts 创建完成
- [ ] productionCalculator.ts 创建完成
- [ ] marketManager.ts 创建完成
- [ ] priceCalculator.ts 创建完成
- [ ] populationManager.ts 创建完成
- [ ] wageCalculator.ts 创建完成
- [ ] livingStandardCalculator.ts 创建完成
- [ ] technologyManager.ts 创建完成
- [ ] researchCalculator.ts 创建完成
- [ ] tileManager.ts 创建完成
- [ ] terrainGenerator.ts 创建完成
- [ ] transportManager.ts 创建完成
- [ ] transportCalculator.ts 创建完成
- [ ] 所有导出文件创建完成

### 测试完成

- [ ] 所有单元测试通过
- [ ] 测试覆盖率 > 80%
- [ ] 所有公共函数/方法有测试

### 代码检查完成

- [ ] `pnpm typecheck` 通过
- [ ] `pnpm lint` 通过
- [ ] 无TypeScript错误
- [ ] 无ESLint错误

---

## 进入下一阶段条件

✅ 所有任务清单完成
✅ 所有系统实现完整
✅ 所有单元测试通过
✅ 测试覆盖率 > 80%
✅ TypeScript类型检查通过
✅ ESLint代码检查通过

---

## 下一步

完成阶段4后，进入[阶段5-UI层实现](./阶段5-UI层实现.md)

**重要提醒：** 确保所有测试通过且覆盖率达标后再进入下一阶段！
