# 阶段4.4：科技系统

## 目标

实现科技树、研发系统、科技解锁机制、科技扩散、时代晋升系统和研发机构。

**重要提示：**
- 本文档只包含接口定义和功能要求，不包含详细代码实现
- 完成后必须进行单元测试
- 测试覆盖率 > 80% 才能进入下一阶段

---

## 任务清单

- [ ] 实现科技树
- [ ] 实现研发系统
- [ ] 实现科技解锁机制
- [ ] 实现科技扩散
- [ ] 实现时代晋升系统
- [ ] 实现研发机构

---

## 接口定义要求

### ITechnologyManager接口

```typescript
interface ITechnologyManager {
  addTechToQueue(techId: string): void
  removeTechFromQueue(techId: string): void
  canResearch(techId: string): boolean
  advanceResearch(days: number): void
  getAvailableTechs(): Technology[]
  getResearchedTechs(): Set<string>
  getResearchQueue(): ResearchQueue
  unlockTech(techId: string): void
}
```

### IResearchCalculator接口

```typescript
interface IResearchCalculator {
  calculateResearchSpeed(
    era: Era,
    population: number,
    education: number,
    institutions: string[]
  ): number
  calculateResearchTime(tech: Technology, speed: number): number
}
```

---

## 功能要求

### 科技管理功能

- 添加科技到研发队列
- 从队列移除科技
- 检查是否可以研发
- 推进研发进度
- 获取可用科技
- 获取已研发科技
- 解锁科技

### 研发计算功能

- 基于时代计算基础速度
- 考虑人口规模
- 考虑教育水平
- 考虑研发机构
- 计算研发时间

### 科技解锁功能

- 检查前置科技
- 检查时代要求
- 检查资源需求
- 解锁建筑
- 解锁生产方式
- 解锁商品

---

## 测试要求

### 科技系统测试

- [ ] 测试科技解锁判断
- [ ] 测试研发队列
- [ ] 测试研发进度推进
- [ ] 测试科技完成
- [ ] 测试前置科技验证
- [ ] 测试研发速度计算
- [ ] 测试科技解锁效果

### 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 实现文件

在 `packages/core/src/systems/technology/` 目录下创建以下文件：

- `technologyManager.ts` - 科技管理器
- `researchCalculator.ts` - 研发计算器
- `index.ts` - 导出文件

---

## 测试文件

创建以下测试文件：

- `packages/core/src/systems/technology/__tests__/technologyManager.test.ts`
- `packages/core/src/systems/technology/__tests__/researchCalculator.test.ts`

---

## 测试运行

```bash
cd packages/core
pnpm test
```

### 测试覆盖率

```bash
cd packages/core
pnpm test:coverage
```

---

## 完成标准

### 功能实现完成

- [ ] 科技管理功能实现完整
- [ ] 研发计算功能实现完整
- [ ] 科技解锁功能实现完整

### 文件创建完成

- [ ] technologyManager.ts 创建完成
- [ ] researchCalculator.ts 创建完成
- [ ] index.ts 创建完成

### 测试完成

- [ ] 所有单元测试通过
- [ ] 测试覆盖率 > 80%
- [ ] 所有公共函数/方法有测试

### 代码检查完成

- [ ] `pnpm typecheck` 通过
- [ ] `pnpm lint` 通过
- [ ] 无TypeScript错误
- [ ] 无ESLint错误

---

## 进入下一阶段条件

✅ 所有任务清单完成
✅ 所有功能实现完整
✅ 所有单元测试通过
✅ 测试覆盖率 > 80%
✅ TypeScript类型检查通过
✅ ESLint代码检查通过

---

## 下一步

完成阶段4.4后，继续执行[阶段4.5-地形地图系统](./阶段4.5-地形地图系统.md)

**重要提醒：** 确保所有测试通过且覆盖率达标后再进入下一阶段！
