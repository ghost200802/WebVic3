# 阶段4.1：生产系统

## 目标

实现建筑堆叠管理、生产方式选择与切换、生产计算、生产效率计算和建筑升级系统。

**重要提示：**
- 本文档只包含接口定义和功能要求，不包含详细代码实现
- 完成后必须进行单元测试
- 测试覆盖率 > 80% 才能进入下一阶段

---

## 任务清单

- [ ] 实现建筑堆叠管理
- [ ] 实现生产方式选择与切换
- [ ] 实现生产计算
- [ ] 实现生产效率计算
- [ ] 实现建筑升级系统

---

## 核心设计说明

### 建筑堆叠逻辑

**同一类型的建筑可以堆叠显示，通过count属性统计数量。**

**堆叠规则：**
- 同一tileId和type的建筑会被合并显示
- 堆叠建筑的maxWorkers = 单个建筑的maxWorkers × count
- 堆叠建筑的workers是所有子建筑的工人总和
- 升级操作对所有堆叠建筑生效

### 生产方式系统

**生产方式由科技解锁，每个建筑类型可以有多个生产方式。**

**生产方式配置结构（按建筑等级）：**
每个生产方式需要定义在不同建筑等级下的参数，包括：
- 该等级下的工人数
- 该等级下的投入商品及数量
- 该等级下的产出商品及数量

---

## 接口定义要求

### IBuildingManager接口

```
interface IBuildingManager {
  createBuilding(configKey: string, tileId: string): Building
  getBuilding(id: string): Building | undefined
  getAllBuildings(): Building[]
  getBuildingsByTile(tileId: string): Building[]
  getBuildingsByType(type: string): Building[]
  getStackedBuildings(tileId: string): ExtendedBuilding[]
  upgradeBuilding(buildingId: string): void
  removeBuilding(buildingId: string): void
  setProductionMethod(buildingId: string, methodId: string): void
  getAvailableProductionMethods(buildingType: string, era: Era, researchedTechs: Set<string>): ProductionMethod[]
}
```

### IProductionCalculator接口

```
interface IProductionCalculator {
  calculateProduction(
    building: Building,
    workers: number,
    era: Era,
    educationLevel: number,
    toolAvailability: number
  ): ProductionResult
  calculateStackedProduction(
    stackedBuilding: ExtendedBuilding,
    era: Era,
    educationLevel: number,
    toolAvailability: number
  ): ProductionResult
  calculateUpgradeCost(building: Building): Record<string, number>
  getProductionMethodLevelConfig(methodId: string, buildingLevel: number): ProductionMethodLevelConfig | undefined
}
```

### IProductionMethodManager接口

```
interface IProductionMethodManager {
  getProductionMethod(methodId: string): ProductionMethod | undefined
  getProductionMethodsByBuilding(buildingType: string): ProductionMethod[]
  checkMethodAvailability(method: ProductionMethod, era: Era, researchedTechs: Set<string>): boolean
  getUnlockedMethods(buildingType: string, era: Era, researchedTechs: Set<string>): ProductionMethod[]
}
```

### ProductionResult接口

```
interface ProductionResult {
  inputs: Map<string, number>
  outputs: Map<string, number>
  efficiency: number
}
```

---

## 功能要求

### 建筑堆叠管理功能

- 创建建筑（根据配置）
- 获取单个建筑
- 获取所有建筑
- 获取地块上的建筑
- 获取按类型分组的建筑
- 获取堆叠后的建筑（同一类型合并显示）
- 升级建筑（升级所有堆叠的建筑）
- 删除建筑
- 切换生产方式（对所有堆叠建筑生效）

### 生产方式管理功能

- 获取建筑可用的生产方式列表
- 检查生产方式是否已解锁（科技、时代）
- 设置建筑的生产方式
- 获取生产方式的等级配置

### 生产计算功能

- 根据工人数量计算产出
- 考虑时代加成
- 考虑教育水平
- 考虑工具可用性
- 计算输入/产出
- 计算生产效率
- 计算堆叠建筑的总产出

### 生产方式配置要求

每个生产方式需要配置不同建筑等级的参数：
- levelConfigs数组包含每个建筑等级的配置
- workers指定该等级下需要的工人数
- inputs/outputs指定该等级下的投入产出
- 产出随等级提升而增加
- 工人数也随等级提升

### 建筑升级功能

- 计算升级成本
- 提升建筑等级（所有堆叠建筑）
- 增加建筑经验
- 解锁新的生产方式（等级达到要求）

---

## 测试要求

### 生产系统测试

- [ ] 测试建筑创建
- [ ] 测试建筑堆叠逻辑（同类型建筑合并）
- [ ] 测试堆叠建筑的工人管理
- [ ] 测试建筑升级（所有堆叠建筑升级）
- [ ] 测试生产方式切换
- [ ] 测试生产方式解锁判断（科技、时代）
- [ ] 测试生产计算
- [ ] 测试堆叠建筑的总产出计算
- [ ] 测试效率计算
- [ ] 测试边界条件（最大工人、最小工人等）
- [ ] 测试生产方式等级配置

### 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 实现文件

在 packages/core/src/systems/production/ 目录下创建以下文件：
- buildingManager.ts - 建筑管理器
- productionCalculator.ts - 生产计算器
- productionMethodManager.ts - 生产方式管理器
- index.ts - 导出文件

---

## 测试文件

创建以下测试文件：
- packages/core/src/systems/production/__tests__/buildingManager.test.ts
- packages/core/src/systems/production/__tests__/productionCalculator.test.ts
- packages/core/src/systems/production/__tests__/productionMethodManager.test.ts

---

## 测试运行

运行单元测试命令：cd packages/core && pnpm test

运行覆盖率测试：cd packages/core && pnpm test:coverage

---

## 完成标准

### 功能实现完成

- [ ] 建筑堆叠管理功能实现完整
- [ ] 生产方式管理功能实现完整
- [ ] 生产计算功能实现完整
- [ ] 建筑升级功能实现完整

### 文件创建完成

- [ ] buildingManager.ts 创建完成
- [ ] productionCalculator.ts 创建完成
- [ ] productionMethodManager.ts 创建完成
- [ ] index.ts 创建完成

### 测试完成

- [ ] 所有单元测试通过
- [ ] 测试覆盖率 > 80%
- [ ] 所有公共函数/方法有测试

### 代码检查完成

- [ ] pnpm typecheck 通过
- [ ] pnpm lint 通过
- [ ] 无TypeScript错误
- [ ] 无ESLint错误

---

## 进入下一阶段条件

✅ 所有任务清单完成
✅ 所有功能实现完整
✅ 所有单元测试通过
✅ 测试覆盖率 > 80%
✅ TypeScript类型检查通过
✅ ESLint代码检查通过

---

## 下一步

完成阶段4.1后，继续执行阶段4.2-市场与价格系统

**重要提醒：** 确保所有测试通过且覆盖率达标后再进入下一阶段！
