# 阶段4.2：价格系统

## 目标

实现基于地块库存的价格计算系统，价格根据每个地块的库存水平独立计算，支持库存上限管理（默认1000，仓库建筑可扩展）。

**重要提示：**
- 本文档只包含接口定义和功能要求，不包含详细代码实现
- 完成后必须进行单元测试
- 测试覆盖率 > 80% 才能进入下一阶段

---

## 任务清单

- [ ] 实现库存上限管理
- [ ] 实现基于库存的价格计算
- [ ] 实现价格更新机制
- [ ] 实现价格历史记录
- [ ] 编写单元测试

---

## 核心设计说明

### 价格计算机制

**价格与库存水平的关系：**

价格根据当前库存量占库存上限的比例进行动态调整：

| 库存占比 | 价格倍数 | 说明 |
|---------|---------|------|
| 0%-20% | 1.0x → 5.0x | 快速增加，库存极度稀缺 |
| 20%-50% | 1.0x → 1.5x | 缓慢增加，库存不足 |
| 50% | 1.0x | 维持基准价格，库存平衡 |
| 50%-80% | 1.0x → 0.67x | 缓慢降低，库存充裕 |
| 80%-100% | 0.67x → 0.2x | 快速降低，库存过剩 |

**价格计算公式：**

- **库存占比 = 当前库存 / 库存上限**

- **0%-20%区间（快速涨价）：**
  - 价格倍数 = 1 + (库存占比 - 0.2) / 0.2 * 4
  - 当库存=0时，价格为5倍基准价格

- **20%-50%区间（缓慢涨价）：**
  - 价格倍数 = 1 + (0.5 - 库存占比) / 0.3 * 0.5
  - 当库存=20%时，价格为1.5倍

- **50%-80%区间（缓慢降价）：**
  - 价格倍数 = 1 - (库存占比 - 0.5) / 0.3 * 0.33
  - 当库存=80%时，价格为0.67倍

- **80%-100%区间（快速降价）：**
  - 价格倍数 = 0.67 - (库存占比 - 0.8) / 0.2 * 0.47
  - 当库存=100%时，价格为0.2倍

### 库存上限系统

**默认配置：**
- 每种物品的默认库存上限：1000
- 库存上限按物品类型独立计算

**仓库建筑扩展：**
- 仓库等级1：增加1000库存上限
- 仓库等级2：增加2000库存上限（累计3000）
- 仓库等级3：增加3000库存上限（累计6000）
- 公式：库存上限 = 基础上限(1000) + 仓库等级 × 1000

### 地块独立性

**每个地块独立计算：**
- 每个地块有自己的价格系统
- 价格基于本地块库存计算
- 不同地块同一商品价格可能不同
- 支持跨地块价格差异

---

## 接口定义要求

### IPriceManager接口

```typescript
interface IPriceManager {
  updateTilePrices(tileId: string, date: GameDate): void
  updateAllPrices(date: GameDate): void
  
  getPrice(tileId: string, goodsId: string): number
  getBasePrice(goodsId: string): number
  
  setBasePrice(goodsId: string, price: number): void
  
  getStorageCapacity(tileId: string, goodsId: string): number
  setStorageCapacity(tileId: string, goodsId: string, capacity: number): void
  
  updateStorageCapacityFromWarehouse(tileId: string, warehouseLevel: number): void
  
  getPriceHistory(tileId: string, goodsId: string): PriceHistoryEntry[]
  recordPrice(tileId: string, goodsId: string, date: GameDate): void
}

interface PriceHistoryEntry {
  date: GameDate
  price: number
  inventory: number
  capacity: number
  ratio: number
}
```

### IPriceCalculator接口

```typescript
interface IPriceCalculator {
  calculatePrice(
    basePrice: number,
    inventory: number,
    capacity: number
  ): number
  
  calculatePriceMultiplier(inventory: number, capacity: number): number
  
  getInventoryRatio(inventory: number, capacity: number): number
}
```

### IStorageCapacityManager接口

```typescript
interface IStorageCapacityManager {
  getCapacity(tileId: string, goodsId: string): number
  setCapacity(tileId: string, goodsId: string, capacity: number): void
  
  getBaseCapacity(goodsId: string): number
  getWarehouseBonus(warehouseLevel: number): number
  
  updateCapacityFromWarehouse(tileId: string, warehouseLevel: number): void
  
  isFull(tileId: string, goodsId: string, amount: number): boolean
}
```

---

## 功能要求

### 价格计算功能

- 基于地块库存动态计算价格
- 根据库存占比应用价格倍数
- 支持基准价格设置
- 平滑价格变化（可选）
- 记录价格历史

### 库存上限管理功能

- 获取物品库存上限
- 设置物品库存上限
- 根据仓库等级自动计算上限
- 检查库存是否已满

### 价格更新功能

- 更新指定地块的所有商品价格
- 更新所有地块的所有商品价格
- 记录价格变化历史
- 支持按日期查询价格历史

### 价格历史功能

- 记录每次价格更新
- 保存库存、上限、占比等信息
- 支持历史价格查询
- 支持价格趋势分析

---

## 与现有系统的集成

### 与库存系统集成

- 从StorageManager获取地块库存数据
- 使用地块库存计算价格
- 价格计算不修改库存数据

### 与建筑系统集成

- 仓库建筑更新时触发库存上限更新
- 仓库等级传递给StorageCapacityManager
- 建筑升级后自动调整库存上限

### 与GameState集成

- 价格数据存储在GameState中
- 支持状态持久化
- 支持价格历史查询

---

## 价格计算示例

### 示例1：基准价格100，库存上限1000

| 库存量 | 占比 | 价格倍数 | 最终价格 |
|-------|------|---------|---------|
| 0 | 0% | 5.0 | 500 |
| 100 | 10% | 3.0 | 300 |
| 200 | 20% | 1.5 | 150 |
| 350 | 35% | 1.25 | 125 |
| 500 | 50% | 1.0 | 100 |
| 650 | 65% | 0.84 | 84 |
| 800 | 80% | 0.67 | 67 |
| 900 | 90% | 0.44 | 44 |
| 1000 | 100% | 0.2 | 20 |

### 示例2：仓库升级的影响

假设基准价格100，当前库存300：

- **无仓库（上限1000）**：
  - 占比：300/1000 = 30%
  - 价格倍数：1.33
  - 最终价格：133

- **1级仓库（上限2000）**：
  - 占比：300/2000 = 15%
  - 价格倍数：2.25
  - 最终价格：225

- **2级仓库（上限3000）**：
  - 占比：300/3000 = 10%
  - 价格倍数：3.0
  - 最终价格：300

---

## 测试要求

### 价格系统测试

- [ ] 测试库存占比计算
- [ ] 测试价格倍数计算（四个区间）
- [ ] 测试边界条件（0%, 20%, 50%, 80%, 100%）
- [ ] 测试基准价格设置和获取
- [ ] 测试地块价格更新
- [ ] 测试所有地块价格更新
- [ ] 测试库存上限获取和设置
- [ ] 测试仓库等级对上限的影响
- [ ] 测试价格历史记录
- [ ] 测试价格历史查询
- [ ] 测试库存已满检查
- [ ] 测试不同地块独立价格
- [ ] 测试价格历史包含完整信息

### 价格倍数测试用例

- [ ] 库存0% → 价格5倍
- [ ] 库存10% → 价格3倍
- [ ] 库存20% → 价格1.5倍
- [ ] 库存35% → 价格1.25倍
- [ ] 库存50% → 价格1倍
- [ ] 库存65% → 价格0.84倍
- [ ] 库存80% → 价格0.67倍
- [ ] 库存90% → 价格0.44倍
- [ ] 库存100% → 价格0.2倍

### 仓库扩展测试用例

- [ ] 默认上限1000
- [ ] 1级仓库增加1000（上限2000）
- [ ] 2级仓库增加2000（上限3000）
- [ ] 3级仓库增加3000（上限6000）
- [ ] 上限变化对价格的影响

### 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试
- 所有边界情况必须有测试

---

## 实现文件

在 `packages/core/src/systems/economy/` 目录下创建以下文件：

- `priceManager.ts` - 价格管理器
- `priceCalculator.ts` - 价格计算器
- `storageCapacityManager.ts` - 库存上限管理器
- `index.ts` - 导出文件

---

## 测试文件

创建以下测试文件：

- `packages/core/src/systems/economy/__tests__/priceManager.test.ts`
- `packages/core/src/systems/economy/__tests__/priceCalculator.test.ts`
- `packages/core/src/systems/economy/__tests__/storageCapacityManager.test.ts`

---

## 测试运行

```bash
cd packages/core
pnpm test
```

### 测试覆盖率

```bash
cd packages/core
pnpm test:coverage
```

---

## 完成标准

### 功能实现完成

- [ ] 价格计算功能实现完整
- [ ] 库存上限管理功能实现完整
- [ ] 价格更新功能实现完整
- [ ] 价格历史功能实现完整

### 文件创建完成

- [ ] priceManager.ts 创建完成
- [ ] priceCalculator.ts 创建完成
- [ ] storageCapacityManager.ts 创建完成
- [ ] index.ts 创建完成

### 测试完成

- [ ] 所有单元测试通过
- [ ] 测试覆盖率 > 80%
- [ ] 所有公共函数/方法有测试
- [ ] 所有边界条件有测试

### 代码检查完成

- [ ] `pnpm typecheck` 通过
- [ ] `pnpm lint` 通过
- [ ] 无TypeScript错误
- [ ] 无ESLint错误

---

## 进入下一阶段条件

✅ 所有任务清单完成
✅ 所有功能实现完整
✅ 所有单元测试通过
✅ 测试覆盖率 > 80%
✅ TypeScript类型检查通过
✅ ESLint代码检查通过

---

## 下一步

完成阶段4.2后，继续执行[阶段4.3-人口与就业系统](./阶段4.3-人口与就业系统.md)

**重要提醒：** 确保所有测试通过且覆盖率达标后再进入下一阶段！
