# 阶段1：项目初始化

## 目标

搭建Monorepo项目结构，配置开发环境，建立基础代码规范。

**重要提示：**
- 本文档只包含接口定义和功能要求，不包含详细代码实现
- 完成后必须进行验证测试
- 所有检查通过后才能进入下一阶段

---

## 任务清单

- [ ] 创建Monorepo项目结构
- [ ] 配置pnpm workspace
- [ ] 初始化Vue3前端项目
- [ ] 初始化Node.js后端项目
- [ ] 创建核心逻辑包
- [ ] 配置TypeScript
- [ ] 配置ESLint代码规范
- [ ] 配置Vite构建工具
- [ ] 配置Jest测试框架
- [ ] 编写项目README

---

## 1. 创建Monorepo项目结构

### 1.1 项目结构要求

```
WebVic3/
├── apps/
│   ├── web/              # Vue3前端应用
│   │   ├── src/
│   │   │   ├── components/
│   │   │   ├── views/
│   │   │   ├── stores/
│   │   │   ├── router/
│   │   │   └── main.ts
│   │   ├── package.json
│   │   ├── vite.config.ts
│   │   └── tsconfig.json
│   └── server/           # Node.js后端应用
│       ├── src/
│       │   ├── routes/
│       │   ├── services/
│       │   ├── models/
│       │   └── index.ts
│       ├── package.json
│       └── tsconfig.json
├── packages/
│   └── core/             # 游戏核心逻辑（共享）
│       ├── src/
│       │   ├── systems/
│       │   │   ├── economy/
│       │   │   ├── production/
│       │   │   ├── population/
│       │   │   ├── technology/
│       │   │   ├── terrain/
│       │   │   ├── transport/
│       │   │   └── time/
│       │   ├── models/
│       │   ├── interfaces/
│       │   ├── utils/
│       │   ├── algorithms/
│       │   └── serialization/
│       ├── __tests__/
│       ├── package.json
│       └── tsconfig.json
├── pnpm-workspace.yaml
├── package.json
├── tsconfig.base.json
├── .eslintrc.cjs
├── .eslintignore
└── README.md
```

### 1.2 根package.json脚本要求

```json
{
  "scripts": {
    "dev": "concurrently \"pnpm --filter web dev\" \"pnpm --filter server dev\"",
    "dev:web": "pnpm --filter web dev",
    "dev:server": "pnpm --filter server dev",
    "build": "pnpm --filter web build && pnpm --filter server build",
    "build:web": "pnpm --filter web build",
    "build:server": "pnpm --filter server build",
    "typecheck": "pnpm --filter web typecheck && pnpm --filter server typecheck",
    "lint": "pnpm --filter web lint && pnpm --filter server lint && pnpm --filter core lint",
    "lint:fix": "pnpm --filter web lint:fix && pnpm --filter server lint:fix && pnpm --filter core lint:fix",
    "test": "pnpm --filter core test",
    "test:coverage": "pnpm --filter core test:coverage"
  }
}
```

### 1.3 pnpm-workspace.yaml要求

```yaml
packages:
  - 'apps/*'
  - 'packages/*'
```

---

## 2. 前端项目配置

### 2.1 前端package.json依赖要求

**生产依赖：**
- vue: ^3.4.0
- pinia: ^2.1.7
- vue-router: ^4.2.5
- @vueuse/core: ^10.7.0

**开发依赖：**
- @vitejs/plugin-vue: ^5.0.0
- @vue/tsconfig: ^0.5.0
- typescript: ^5.3.0
- vite: ^5.0.0
- vue-tsc: ^1.8.27
- tailwindcss: ^3.4.0
- autoprefixer: ^10.4.16
- postcss: ^8.4.32

### 2.2 Vite配置要求

**vite.config.ts功能要求：**
- 注册Vue插件
- 配置路径别名：
  - `@/` 指向 `src/`
  - `@core/` 指向 `../../packages/core/src/`
- 开发服务器配置：
  - 端口：3000
  - 代理配置：`/api` 代理到 `http://localhost:3001`

### 2.3 TypeScript配置要求

**tsconfig.json配置要求：**
- 继承 `@vue/tsconfig/tsconfig.dom.json`
- 配置路径别名
- 包含 `vite/client` 类型

### 2.4 基础文件要求

- `index.html`: 包含 `<div id="app"></div>` 和 main.ts 引用
- `src/main.ts`: 创建Vue应用，注册Pinia，挂载到 #app
- `src/App.vue`: 基础根组件
- `src/style.css`: 包含 Tailwind CSS 指令

---

## 3. 后端项目配置

### 3.1 后端package.json依赖要求

**生产依赖：**
- fastify: ^4.25.0
- @fastify/cors: ^8.5.0
- mongodb: ^6.3.0

**开发依赖：**
- @types/node: ^20.10.0
- tsx: ^4.7.0
- typescript: ^5.3.0

### 3.2 脚本要求

```json
{
  "scripts": {
    "dev": "tsx watch src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js",
    "typecheck": "tsc --noEmit",
    "lint": "eslint src --ext .ts --fix",
    "lint:fix": "eslint src --ext .ts --fix"
  }
}
```

### 3.3 TypeScript配置要求

**tsconfig.json配置要求：**
- 输出目录：`./dist`
- 源目录：`./src`
- 启用严格模式
- 启用声明文件生成

### 3.4 基础服务器要求

**src/index.ts功能要求：**
- 创建Fastify实例
- 注册CORS插件
- 配置GET `/` 路由返回欢迎消息
- 监听端口3001
- 错误处理

---

## 4. 核心逻辑包配置

### 4.1 核心包package.json依赖要求

**生产依赖：** 无（保持纯TypeScript）

**开发依赖：**
- @types/jest: ^29.5.11
- @types/node: ^20.10.0
- jest: ^29.7.0
- ts-jest: ^29.1.1
- typescript: ^5.3.0

### 4.2 脚本要求

```json
{
  "scripts": {
    "build": "tsc",
    "dev": "tsc --watch",
    "typecheck": "tsc --noEmit",
    "test": "jest",
    "test:coverage": "jest --coverage",
    "lint": "eslint src --ext .ts --fix",
    "lint:fix": "eslint src --ext .ts --fix"
  }
}
```

### 4.3 目录结构要求

```
packages/core/src/
├── systems/
│   ├── economy/
│   ├── production/
│   ├── population/
│   ├── technology/
│   ├── terrain/
│   ├── transport/
│   └── time/
├── models/
├── interfaces/
├── utils/
├── algorithms/
└── serialization/
```

### 4.4 TypeScript配置要求

**tsconfig.json配置要求：**
- 启用声明文件生成
- 启用声明映射
- 排除测试文件

### 4.5 Jest配置要求

**jest.config.js配置要求：**
- 使用 `ts-jest` preset
- 测试环境：node
- 测试文件模式：`**/*.test.ts` 或 `**/*.spec.ts`
- 覆盖率收集排除 `**/*.d.ts`、`**/*.test.ts`、`**/index.ts`

---

## 5. TypeScript基础配置

### 5.1 tsconfig.base.json要求

**编译选项要求：**
- target: ES2022
- module: ESNext
- 启用严格模式
- 启用 `noUnusedLocals`、`noUnusedParameters`、`noFallthroughCasesInSwitch`
- 启用 `esModuleInterop`、`skipLibCheck`

---

## 6. ESLint配置

### 6.1 .eslintrc.cjs配置要求

**基础配置要求：**
- 扩展：`eslint:recommended`、`plugin:@typescript-eslint/recommended`
- Parser: `@typescript-eslint/parser`
- 环境：browser、es2021、node

**规则要求：**
- `@typescript-eslint/no-unused-vars`: error（忽略 `_` 开头的参数）
- `@typescript-eslint/no-explicit-any`: warn
- `@typescript-eslint/explicit-function-return-type`: off
- `@typescript-eslint/no-non-null-assertion`: warn

### 6.2 .eslintignore要求

忽略以下目录：
- dist
- node_modules
- *.config.js
- *.config.ts
- coverage

---

## 7. Tailwind CSS配置

### 7.1 tailwind.config.js要求

**配置要求：**
- content 包含 `index.html` 和 `src/**/*.{vue,js,ts,jsx,tsx}`

### 7.2 postcss.config.js要求

**插件要求：**
- tailwindcss
- autoprefixer

---

## 8. README文档要求

### 8.1 内容要求

README.md必须包含以下章节：
- 项目简介
- 技术栈
- 项目结构
- 快速开始
  - 安装依赖
  - 启动开发环境
  - 构建项目
- 运行代码检查
- 开发文档链接
- 分系统文档链接
- 开发规范说明
- License

---

## 验证测试要求

### 9.1 安装依赖测试

**测试步骤：**
```bash
cd /Users/work/WebVic3
pnpm install
```

**验证条件：**
- [ ] 所有依赖安装成功，无错误
- [ ] node_modules 目录生成正确

### 9.2 前端启动测试

**测试步骤：**
```bash
pnpm dev:web
```

**验证条件：**
- [ ] 开发服务器成功启动在 http://localhost:3000
- [ ] 页面正确显示
- [ ] 控制台无错误

### 9.3 后端启动测试

**测试步骤：**
```bash
pnpm dev:server
```

**验证条件：**
- [ ] 服务器成功启动在 http://localhost:3001
- [ ] 访问 `/` 返回正确响应
- [ ] 控制台显示服务器启动日志

### 9.4 类型检查测试

**测试步骤：**
```bash
pnpm typecheck
```

**验证条件：**
- [ ] 前端类型检查通过
- [ ] 后端类型检查通过
- [ ] 核心包类型检查通过
- [ ] 无TypeScript错误

### 9.5 代码检查测试

**测试步骤：**
```bash
pnpm lint
```

**验证条件：**
- [ ] 前端ESLint检查通过
- [ ] 后端ESLint检查通过
- [ ] 核心包ESLint检查通过
- [ ] 无ESLint错误或警告（警告可以忽略）

### 9.6 测试框架测试

**测试步骤：**
```bash
cd packages/core
pnpm test
```

**验证条件：**
- [ ] Jest成功运行
- [ ] 显示测试统计信息
- [ ] 即使没有测试，也应该显示 "No tests found" 而不是错误

### 9.7 联合启动测试

**测试步骤：**
```bash
pnpm dev
```

**验证条件：**
- [ ] 前端和后端同时启动
- [ ] 前端运行在 3000 端口
- [ ] 后端运行在 3001 端口
- [ ] 两者都正常运行，无错误

---

## 完成标准

### 项目结构完成

- [ ] Monorepo目录结构创建完整
- [ ] apps/web 目录包含所有必需文件
- [ ] apps/server 目录包含所有必需文件
- [ ] packages/core 目录包含所有必需子目录

### 配置文件完成

- [ ] 根package.json配置正确
- [ ] pnpm-workspace.yaml配置正确
- [ ] tsconfig.base.json配置正确
- [ ] .eslintrc.cjs配置正确
- [ ] .eslintignore配置正确

### 前端配置完成

- [ ] package.json包含所有必需依赖
- [ ] vite.config.ts配置正确
- [ ] tsconfig.json配置正确
- [ ] tailwind.config.js配置正确
- [ ] postcss.config.js配置正确
- [ ] index.html、main.ts、App.vue创建完成

### 后端配置完成

- [ ] package.json包含所有必需依赖
- [ ] tsconfig.json配置正确
- [ ] 基础服务器可以运行

### 核心包配置完成

- [ ] package.json配置正确
- [ ] tsconfig.json配置正确
- [ ] jest.config.js配置正确
- [ ] 所有子目录创建完成
- [ ] 入口文件创建完成

### 文档完成

- [ ] README.md编写完整，包含所有必需章节

### 测试验证完成

- [ ] pnpm install 成功
- [ ] pnpm dev:web 成功启动
- [ ] pnpm dev:server 成功启动
- [ ] pnpm dev 同时启动成功
- [ ] pnpm typecheck 通过
- [ ] pnpm lint 通过
- [ ] pnpm test 可以运行

---

## 进入下一阶段条件

✅ 所有任务清单完成
✅ 所有配置文件创建完成
✅ 所有验证测试通过
✅ TypeScript类型检查通过
✅ ESLint代码检查通过
✅ README文档完整

---

## 下一步

完成阶段1后，进入[阶段2-核心数据模型](./阶段2-核心数据模型.md)

**重要提醒：** 确保所有测试通过后再进入下一阶段！
