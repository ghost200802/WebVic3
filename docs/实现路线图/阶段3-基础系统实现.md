# 阶段3：基础系统实现

## 目标

实现游戏的基础支撑系统，为后续系统提供基础设施。

**重要提示：**
- 本文档只包含接口定义和功能要求，不包含详细代码实现
- 完成后必须进行单元测试
- 测试覆盖率 > 80% 才能进入下一阶段

---

## 任务清单

- [ ] 实现时间系统
  - 游戏时间推进
  - Tick机制
  - 时间事件调度
- [ ] 实现时代系统
  - 时代晋升判断
  - 时代加成计算
  - 时代事件触发
- [ ] 实现存档系统
  - 状态序列化
  - 状态反序列化
  - 自动保存机制
- [ ] 实现事件系统
  - 事件发射器
  - 事件订阅
  - 事件队列
- [ ] 实现工具函数库
  - 数学计算函数
  - 随机数生成
  - 数据验证
- [ ] 编写单元测试

---

## 1. 时间系统

### 1.1 创建文件

在 `packages/core/src/systems/time/` 创建 `timeManager.ts`

### 1.2 接口定义要求

**TimeConfig接口：**
```typescript
interface TimeConfig {
  daysPerTick: number
  tickInterval: number
}
```

**ITimeManager接口：**
```typescript
interface ITimeManager {
  advance(days: number): void
  getCurrentDate(): GameDate
  getTickCount(): number
  subscribe(listener: (date: GameDate) => void): () => void
}
```

### 1.3 功能要求

**TimeManager类要求：**

| 方法 | 说明 | 参数 | 返回值 |
|------|------|------|--------|
| constructor | 构造函数 | initialDate: GameDate, config: TimeConfig | - |
| advance | 推进时间 | days: number | void |
| getCurrentDate | 获取当前日期 | - | GameDate |
| getTickCount | 获取Tick计数 | - | number |
| subscribe | 订阅日期变化 | listener: (date: GameDate) => void | 取消订阅函数 |

**时间推进规则：**
- 支持推进任意天数
- 每个月最多30天
- 超过30天自动进位到下个月
- 每年12个月
- 超过12个月自动进位到下一年

**订阅机制：**
- 支持多个监听器
- 每次时间推进后通知所有监听器
- 返回取消订阅函数

### 1.4 测试要求

**时间系统测试：**
- [ ] 测试时间推进功能（单日、多日）
- [ ] 测试月份进位逻辑（第31天变为第1天下个月）
- [ ] 测试年份进位逻辑（第13个月变为第1月下一年）
- [ ] 测试Tick计数递增
- [ ] 测试订阅和取消订阅
- [ ] 测试多个监听器通知
- [ ] 测试初始日期设置
- [ ] 测试日期返回值是副本（防止外部修改）

### 1.5 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 2. 时代系统

### 2.1 创建文件

在 `packages/core/src/systems/` 创建 `eraManager.ts`

### 2.2 接口定义要求

**IEraManager接口：**
```typescript
interface IEraManager {
  getCurrentEra(): Era
  checkAdvancement(state: GameState): Era | null
  advanceTo(era: Era): void
  onEraChange(listener: (newEra: Era) => void): () => void
}
```

**EraAdvancementCriteria接口：**
```typescript
interface EraAdvancementCriteria {
  minPopulation: number
  minTechnologies: number
  requiredTechnologies: string[]
  minBuildings: number
  requiredBuildings: string[]
}
```

### 2.3 功能要求

**时代晋升条件（示例）：**

| 时代 | 最小人口 | 所需科技 | 所需建筑 |
|------|---------|---------|---------|
| bronze_age | 100 | stone_tool | workshop |
| iron_age | 500 | metal_smelting | mine, bronze_workshop |
| classical | 2000 | iron_smelting | academy |
| medieval | 5000 | writing | university |
| renaissance | 10000 | printing_press | market |
| industrial | 50000 | steam_engine | factory |
| electrical | 100000 | electricity | power_plant |
| information | 500000 | computer | computer_center |
| ai_age | 1000000 | ai | ai_research_center |

**时代加成计算：**
- 每个时代有不同的生产效率加成
- 每个时代有不同的研发速度加成
- 每个时代有不同的人口增长加成

**时代变化事件：**
- 时代晋升时触发事件
- 通知所有订阅者

### 2.4 测试要求

**时代系统测试：**
- [ ] 测试时代晋升判断逻辑
- [ ] 测试所有时代的晋升条件验证
- [ ] 测试时代加成计算
- [ ] 测试时代变化事件触发
- [ ] 测试订阅和取消订阅
- [ ] 测试时代推进功能
- [ ] 测试不满足条件时不晋升
- [ ] 测试时代回退不被允许

### 2.5 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 3. 存档系统

### 3.1 创建文件

在 `packages/core/src/serialization/` 创建 `saveSerializer.ts`

### 3.2 接口定义要求

**ISaveSerializer接口：**
```typescript
interface ISaveSerializer {
  serialize(state: GameState): string
  deserialize(json: string): GameState
}
```

**SaveData接口：**
```typescript
interface SaveData {
  version: string
  timestamp: number
  state: any
}
```

### 3.3 功能要求

**序列化功能：**
- 将GameState序列化为JSON字符串
- 处理Map类型（转换为对象数组）
- 处理Set类型（转换为数组）
- 处理循环引用（使用弱引用或特殊标记）
- 包含版本号和时间戳
- 压缩数据（可选）

**反序列化功能：**
- 将JSON字符串反序列化为GameState
- 还原Map类型
- 还原Set类型
- 验证版本兼容性
- 数据完整性检查
- 错误处理和恢复

**自动保存机制：**
- 定时保存（可配置间隔）
- 保存前验证数据完整性
- 保留多个历史存档（可配置数量）
- 存档清理策略（删除最旧的存档）

### 3.4 测试要求

**存档系统测试：**
- [ ] 测试状态序列化
- [ ] 测试状态反序列化
- [ ] 测试Map类型的序列化和反序列化
- [ ] 测试Set类型的序列化和反序列化
- [ ] 测试嵌套对象的序列化
- [ ] 测试循环引用处理
- [ ] 测试版本兼容性验证
- [ ] 测试数据完整性检查
- [ ] 测试错误处理（无效JSON、缺失字段等）
- [ ] 测试自动保存机制

### 3.5 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 4. 事件系统

### 4.1 创建文件

在 `packages/core/src/` 创建 `eventEmitter.ts`

### 4.2 接口定义要求

**GameEvent接口：**
```typescript
interface GameEvent {
  type: string
  data?: any
  timestamp: number
}
```

**EventHandler接口：**
```typescript
type EventHandler = (event: GameEvent) => void
```

**IGameEventEmitter接口：**
```typescript
interface IGameEventEmitter {
  emit(event: GameEvent): void
  on(eventType: string, handler: EventHandler): void
  off(eventType: string, handler: EventHandler): void
  once(eventType: string, handler: EventHandler): void
  clear(eventType?: string): void
}
```

### 4.3 功能要求

**事件发射器功能：**
- 发射事件到所有订阅者
- 按事件类型订阅
- 取消订阅
- 一次性订阅（执行一次后自动取消）
- 清除特定类型或所有订阅者
- 事件优先级（可选）
- 事件队列（异步处理）

**事件系统要求：**
- 线程安全（多订阅者并发）
- 错误隔离（一个订阅者错误不影响其他）
- 性能优化（高频事件处理）

### 4.4 测试要求

**事件系统测试：**
- [ ] 测试事件发射
- [ ] 测试事件订阅
- [ ] 测试事件取消订阅
- [ ] 测试多订阅者
- [ ] 测试一次性订阅
- [ ] 测试清除订阅者
- [ ] 测试不同事件类型
- [ ] 测试事件数据传递
- [ ] 测试错误隔离
- [ ] 测试性能（大量订阅者）

### 4.5 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共方法必须有测试

---

## 5. 工具函数库

### 5.1 创建文件

在 `packages/core/src/utils/` 创建以下文件：
- `math.ts` - 数学计算函数
- `random.ts` - 随机数生成
- `validation.ts` - 数据验证

### 5.2 数学函数要求

**math.ts 必须包含的函数：**

| 函数名 | 说明 | 参数 | 返回值 |
|--------|------|------|--------|
| clamp | 数值限制 | value, min, max | number |
| lerp | 线性插值 | a, b, t | number |
| mapRange | 范围映射 | value, inMin, inMax, outMin, outMax | number |
| clampRange | 范围限制 | value, min, max | number |
| lerpAngle | 角度插值 | a, b, t | number |
| distance | 欧几里得距离 | x1, y1, x2, y2 | number |
| normalizeAngle | 角度归一化 | angle | number |

### 5.3 随机数生成要求

**random.ts Random类要求：**

| 方法 | 说明 | 参数 | 返回值 |
|------|------|------|--------|
| constructor | 构造函数 | seed?: number | - |
| next | 生成0-1随机数 | - | number |
| nextInt | 生成指定范围整数 | min, max | number |
| nextFloat | 生成指定范围浮点数 | min, max | number |
| nextBool | 生成布尔值 | probability?: number | boolean |
| nextArrayItem | 随机选择数组元素 | array | T |
| nextArrayItems | 随机选择多个元素 | array, count | T[] |
| shuffle | 打乱数组 | array | T[] |
| weightedRandom | 按权重随机选择 | items: {item, weight}[] | T |

**要求：**
- 支持种子随机（可重现结果）
- 均匀分布
- 性能优化

### 5.4 数据验证要求

**validation.ts 必须包含的函数：**

| 函数名 | 说明 | 参数 | 返回值 |
|--------|------|------|--------|
| isGameDate | 验证游戏日期 | date: any | boolean |
| isEra | 验证时代 | era: any | boolean |
| isGoodsType | 验证商品类型 | type: any | boolean |
| isBuildingType | 验证建筑类型 | type: any | boolean |
| isPositiveNumber | 验证正数 | value: any | boolean |
| isNonNegativeNumber | 验证非负数 | value: any | boolean |
| isPercentage | 验证百分比 | value: any | boolean |
| validateGameState | 验证游戏状态 | state: any | ValidationResult |

### 5.5 测试要求

**数学函数测试：**
- [ ] 测试clamp函数（边界值、正常值）
- [ ] 测试lerp函数（0、0.5、1）
- [ ] 测试mapRange函数
- [ ] 测试distance函数
- [ ] 测试角度函数

**随机数测试：**
- [ ] 测试next方法分布均匀性
- [ ] 测试nextInt方法边界值
- [ ] 测试nextFloat方法范围
- [ ] 测试nextBool方法概率
- [ ] 测试nextArrayItem方法
- [ ] 测试shuffle方法
- [ ] 测试weightedRandom方法
- [ ] 测试种子随机可重现性
- [ ] 测试随机数分布统计

**数据验证测试：**
- [ ] 测试所有验证函数
- [ ] 测试有效值验证
- [ ] 测试无效值验证
- [ ] 测试边界值验证
- [ ] 测试validateGameState函数

### 5.6 测试覆盖率要求

- 代码覆盖率 > 80%
- 所有公共函数必须有测试

---

## 6. 创建导出文件

### 6.1 创建系统导出文件

在 `packages/core/src/systems/` 创建 `index.ts`

**导出内容：**
- timeManager.ts 中的所有内容
- eraManager.ts 中的所有内容

### 6.2 创建工具函数导出文件

在 `packages/core/src/utils/` 创建 `index.ts`

**导出内容：**
- math.ts 中的所有内容
- random.ts 中的所有内容
- validation.ts 中的所有内容

### 6.3 创建序列化导出文件

在 `packages/core/src/serialization/` 创建 `index.ts`

**导出内容：**
- saveSerializer.ts 中的所有内容

### 6.4 创建全局导出文件

在 `packages/core/src/` 创建 `index.ts`

**导出内容：**
- models 中的所有内容
- systems 中的所有内容
- utils 中的所有内容
- serialization 中的所有内容

---

## 7. 编写单元测试

### 7.1 创建测试文件

创建以下测试文件：
- `packages/core/src/systems/time/__tests__/timeManager.test.ts`
- `packages/core/src/systems/__tests__/eraManager.test.ts`
- `packages/core/src/serialization/__tests__/saveSerializer.test.ts`
- `packages/core/src/__tests__/eventEmitter.test.ts`
- `packages/core/src/utils/__tests__/math.test.ts`
- `packages/core/src/utils/__tests__/random.test.ts`
- `packages/core/src/utils/__tests__/validation.test.ts`

### 7.2 测试运行

```bash
cd packages/core
pnpm test
```

### 7.3 测试覆盖率

```bash
cd packages/core
pnpm test:coverage
```

---

## 完成标准

### 功能实现完成

- [ ] 时间系统实现完整
- [ ] 时代系统实现完整
- [ ] 存档系统实现完整
- [ ] 事件系统实现完整
- [ ] 工具函数库实现完整

### 文件创建完成

- [ ] timeManager.ts 创建完成
- [ ] eraManager.ts 创建完成
- [ ] saveSerializer.ts 创建完成
- [ ] eventEmitter.ts 创建完成
- [ ] math.ts 创建完成
- [ ] random.ts 创建完成
- [ ] validation.ts 创建完成
- [ ] 所有导出文件创建完成

### 测试完成

- [ ] 所有单元测试通过
- [ ] 测试覆盖率 > 80%
- [ ] 所有公共函数/方法有测试

### 代码检查完成

- [ ] `pnpm typecheck` 通过
- [ ] `pnpm lint` 通过
- [ ] 无TypeScript错误
- [ ] 无ESLint错误

---

## 进入下一阶段条件

✅ 所有任务清单完成
✅ 所有系统实现完整
✅ 所有单元测试通过
✅ 测试覆盖率 > 80%
✅ TypeScript类型检查通过
✅ ESLint代码检查通过

---

## 下一步

完成阶段3后，进入[阶段4-高级系统实现](./阶段4-高级系统实现.md)

**重要提醒：** 确保所有测试通过且覆盖率达标后再进入下一阶段！
