# 阶段2：核心数据模型

## 目标

定义所有游戏系统的核心数据模型，建立类型系统。

**重要提示：**
- 本文档只包含接口定义和功能要求，不包含详细代码实现
- 完成后必须进行类型检查
- 所有检查通过后才能进入下一阶段

---

## 任务清单

- [ ] 定义基础类型（时代、商品、建筑等）
- [ ] 定义商品模型（Goods）
- [ ] 定义建筑模型（Building）
- [ ] 定义生产方式模型（ProductionMethod）
- [ ] 定义市场模型（Market）
- [ ] 定义人口模型（Population）
- [ ] 定义科技模型（Technology）
- [ ] 定义地块模型（Tile）
- [ ] 定义运输模型（Transport）
- [ ] 定义游戏状态模型（GameState）
- [ ] 编写类型测试

---

## 1. 定义基础类型

### 1.1 创建文件

在 `packages/core/src/models/` 创建 `baseTypes.ts`

### 1.2 类型定义要求

**必须定义的枚举类型：**

| 枚举名称 | 说明 | 必需值 |
|---------|------|--------|
| `Era` | 时代 | stone_age, bronze_age, iron_age, classical, medieval, renaissance, industrial, electrical, information, ai_age |
| `BuildingType` | 建筑类型 | farm, ranch, forestry, fishery, quarry, mine, workshop, factory, modern_factory, warehouse, market, port, train_station, academy, university, laboratory |
| `GoodsType` | 商品类型 | raw_material, intermediate, final, luxury, military |
| `AgeGroup` | 年龄组 | child, adult, elder |
| `EducationLevel` | 教育水平 | illiterate, basic, primary, secondary, university, postgraduate |
| `SocialClass` | 社会阶级 | elite, middle, worker, poor |
| `EmploymentStatus` | 就业状态 | employed, unemployed, retired |
| `TerrainType` | 地形类型 | plains, forest, hills, water, desert, snow, swamp, mountain |

**必须定义的类型：**

| 类型名称 | 说明 | 字段 |
|---------|------|------|
| `GameDate` | 游戏日期 | year, month, day |

### 1.3 测试要求

- [ ] 所有枚举值正确导出
- [ ] 类型定义完整
- [ ] TypeScript类型检查通过

---

## 2. 定义商品模型

### 2.1 创建文件

在 `packages/core/src/models/` 创建 `goods.ts`

### 2.2 接口定义要求

**Goods接口：**
```typescript
interface Goods {
  id: string
  name: string
  type: GoodsType
  era: string
  basePrice: number
  priceHistory: PriceRecord[]
}
```

**PriceRecord接口：**
```typescript
interface PriceRecord {
  date: GameDate
  price: number
  supply: number
  demand: number
}
```

### 2.3 商品配置要求

**必须定义的商品配置：**

| 商品ID | 名称 | 类型 | 时代 | 基础价格 |
|--------|------|------|------|----------|
| grain | 谷物 | raw_material | stone_age | 10 |
| meat | 肉类 | raw_material | stone_age | 30 |
| wood | 木材 | raw_material | stone_age | 5 |
| stone | 石材 | raw_material | stone_age | 8 |
| copper | 铜 | raw_material | bronze_age | 25 |
| tin | 锡 | raw_material | bronze_age | 30 |
| iron | 铁 | raw_material | iron_age | 20 |
| coal | 煤炭 | raw_material | industrial | 15 |
| steel | 钢材 | intermediate | industrial | 100 |
| oil | 石油 | raw_material | electrical | 80 |

### 2.4 测试要求

- [ ] Goods接口定义正确
- [ ] PriceRecord接口定义正确
- [ ] 至少定义10种商品
- [ ] 商品配置导出正确
- [ ] TypeScript类型检查通过

---

## 3. 定义建筑模型

### 3.1 创建文件

在 `packages/core/src/models/` 创建 `building.ts`

### 3.2 接口定义要求

**Building接口：**
```typescript
interface Building {
  id: string
  name: string
  type: BuildingType
  minEra: Era
  maxEra?: Era
  constructionCost: Record<string, number>
  constructionTime: number
  baseWorkers: number
  maxWorkers: number
  baseThroughput: number
  productionMethods: string[]
  level: number
  experience: number
  tileId: string
}
```

**BuildingConfig接口：**
```typescript
interface BuildingConfig {
  id: string
  name: string
  type: BuildingType
  minEra: Era
  baseWorkers: number
  maxWorkers: number
  baseThroughput: number
  constructionCost: Record<string, number>
  constructionTime: number
  productionMethods: string[]
}
```

### 3.3 建筑配置要求

**必须定义的建筑配置：**

| 建筑ID | 名称 | 类型 | 最小时代 | 基础工人 | 最大工人 | 基础产出 |
|--------|------|------|---------|----------|----------|----------|
| farm | 农田 | farm | stone_age | 10 | 20 | 100 |
| ranch | 牧场 | ranch | stone_age | 8 | 15 | 50 |
| forestry | 林场 | forestry | stone_age | 10 | 20 | 80 |
| fishery | 渔场 | fishery | stone_age | 5 | 10 | 40 |
| quarry | 采石场 | quarry | stone_age | 12 | 20 | 60 |
| mine | 矿场 | mine | bronze_age | 15 | 25 | 80 |
| workshop | 作坊 | workshop | bronze_age | 8 | 15 | 50 |
| factory | 工厂 | factory | industrial | 50 | 100 | 200 |
| modern_factory | 现代工厂 | modern_factory | electrical | 30 | 60 | 300 |
| warehouse | 仓库 | warehouse | stone_age | 2 | 5 | 0 |

### 3.4 测试要求

- [ ] Building接口定义正确
- [ ] BuildingConfig接口定义正确
- [ ] 至少定义10种建筑
- [ ] 建筑配置导出正确
- [ ] TypeScript类型检查通过

---

## 4. 定义生产方式模型

### 4.1 创建文件

在 `packages/core/src/models/` 创建 `productionMethod.ts`

### 4.2 接口定义要求

**ProductionMethod接口：**
```typescript
interface ProductionMethod {
  id: string
  name: string
  buildingType: string
  requiredTech?: string[]
  requiredEra?: Era
  inputs: Record<string, number>
  outputs: Record<string, number>
  throughputModifier: number
  workerEfficiency: number
  pollution?: number
  automationLevel: number
}
```

### 4.3 生产方式配置要求

**必须定义的生产方式（示例）：**

| 生产方式ID | 名称 | 建筑类型 | 所需时代 | 自动化等级 |
|-----------|------|---------|----------|-----------|
| slash_burn | 刀耕火种 | farm | stone_age | 0 |
| plowing | 畜力耕作 | farm | bronze_age | 0.1 |
| mechanized | 机械化 | farm | industrial | 0.5 |
| modern | 现代农业 | farm | information | 0.8 |
| handcraft | 手工制作 | workshop | stone_age | 0 |
| steam_power | 蒸汽动力 | factory | industrial | 0.2 |
| assembly_line | 流水线生产 | factory | electrical | 0.5 |
| automation | 自动化生产 | factory | information | 0.8 |
| smart | 智能制造 | factory | ai_age | 0.95 |

### 4.4 测试要求

- [ ] ProductionMethod接口定义正确
- [ ] 至少定义8种生产方式
- [ ] 生产方式配置导出正确
- [ ] TypeScript类型检查通过

---

## 5. 定义市场模型

### 5.1 创建文件

在 `packages/core/src/models/` 创建 `market.ts`

### 5.2 接口定义要求

**Market接口：**
```typescript
interface Market {
  id: string
  name: string
  regions: string[]
  prices: Map<string, Price>
  supply: Map<string, number>
  demand: Map<string, number>
  stockpile: Map<string, number>
  events: MarketEvent[]
}
```

**Price接口：**
```typescript
interface Price {
  basePrice: number
  currentPrice: number
  previousPrice: number
  history: PriceRecord[]
}
```

**MarketEvent接口：**
```typescript
interface MarketEvent {
  id: string
  type: 'harvest' | 'famine' | 'boom' | 'recession' | 'discovery'
  description: string
  startDate: GameDate
  endDate?: GameDate
  effects: {
    supplyModifier?: Record<string, number>
    demandModifier?: Record<string, number>
    priceModifier?: Record<string, number>
  }
  isActive: boolean
}
```

**Trade接口：**
```typescript
interface Trade {
  id: string
  fromMarket: string
  toMarket: string
  goods: {
    goodsId: string
    amount: number
    price: number
  }[]
  transportCost: number
  tariff: number
  status: 'active' | 'pending' | 'cancelled'
}
```

### 5.3 测试要求

- [ ] Market接口定义正确
- [ ] Price接口定义正确
- [ ] MarketEvent接口定义正确
- [ ] Trade接口定义正确
- [ ] TypeScript类型检查通过

---

## 6. 定义人口模型

### 6.1 创建文件

在 `packages/core/src/models/` 创建 `population.ts`

### 6.2 接口定义要求

**PopulationGroup接口：**
```typescript
interface PopulationGroup {
  id: string
  size: number
  ageGroup: AgeGroup
  education: EducationLevel
  socialClass: SocialClass
  employment: EmploymentStatus
  workplace?: string
  profession?: string
  wage: number
  wealth: number
  livingStandard: number
  needs: {
    survival: number
    basic: number
    improved: number
    luxury: number
  }
}
```

**Population接口：**
```typescript
interface Population {
  id: string
  tileId: string
  totalPopulation: number
  groups: PopulationGroup[]
  ageDistribution: {
    children: number
    adults: number
    elders: number
  }
  educationDistribution: Record<EducationLevel, number>
  classDistribution: Record<SocialClass, number>
  employment: {
    total: number
    employed: number
    unemployed: number
    retired: number
  }
  averageWage: number
  averageLivingStandard: number
  birthRate: number
  deathRate: number
  netMigration: number
}
```

**Profession接口：**
```typescript
interface Profession {
  id: string
  name: string
  buildingType: string
  baseWage: number
  requiredEducation: EducationLevel
  skillModifier: number
}
```

### 6.3 测试要求

- [ ] PopulationGroup接口定义正确
- [ ] Population接口定义正确
- [ ] Profession接口定义正确
- [ ] TypeScript类型检查通过

---

## 7. 定义科技模型

### 7.1 创建文件

在 `packages/core/src/models/` 创建 `technology.ts`

### 7.2 接口定义要求

**Technology接口：**
```typescript
interface Technology {
  id: string
  name: string
  description: string
  era: Era
  prerequisites: string[]
  researchCost: number
  moneyCost: number
  goodsCost: Record<string, number>
  baseResearchTime: number
  unlocks: {
    buildings?: string[]
    productionMethods?: string[]
    goods?: string[]
    policies?: string[]
    units?: string[]
  }
  effects: TechEffect[]
}
```

**TechEffect接口：**
```typescript
interface TechEffect {
  type: 'production_efficiency' | 'military' | 'population' | 'economy' | 'research'
  target?: string
  modifier: number
}
```

**ResearchQueue接口：**
```typescript
interface ResearchQueue {
  current: {
    tech: string
    progress: number
    estimatedCompletion: GameDate
  }
  queue: string[]
  researchSpeed: number
}
```

### 7.3 科技配置要求

**必须定义的科技（示例）：**

| 科技ID | 名称 | 时代 | 前置科技 | 研发成本 |
|--------|------|------|---------|----------|
| stone_tool | 石器制作 | stone_age | 无 | 50 |
| metal_smelting | 金属冶炼 | bronze_age | stone_tool | 200 |
| iron_smelting | 铁器冶炼 | iron_age | metal_smelting | 400 |
| steam_engine | 蒸汽机 | industrial | mechanics, coal_mining | 2000 |
| electricity | 电力 | electrical | steam_engine, physics | 3000 |
| computer | 计算机 | information | electricity, electronics | 5000 |
| ai | 人工智能 | ai_age | computer, machine_learning | 10000 |

### 7.4 测试要求

- [ ] Technology接口定义正确
- [ ] TechEffect接口定义正确
- [ ] ResearchQueue接口定义正确
- [ ] 至少定义7种科技
- [ ] 科技配置导出正确
- [ ] TypeScript类型检查通过

---

## 8. 定义地块模型

### 8.1 创建文件

在 `packages/core/src/models/` 创建 `tile.ts`

### 8.2 接口定义要求

**Tile接口：**
```typescript
interface Tile {
  id: string
  name: string
  terrainComposition: Map<TerrainType, number>
  totalArea: number
  buildableArea: number
  usedArea: number
  resources: ResourceDeposit[]
  buildings: string[]
  isExplored: boolean
  isControlled: boolean
  controlCost: number
  roadLevel: number
  transportHub?: string
  developmentLevel: number
  developmentExperience: number
}
```

**ResourceDeposit接口：**
```typescript
interface ResourceDeposit {
  id: string
  type: string
  totalAmount: number
  currentAmount: number
  extractionDifficulty: number
  richness: DepositRichness
  requiredTech: string[]
  requiredBuilding: string
  isDiscovered: boolean
  isActive: boolean
}
```

**DepositRichness枚举：**
```typescript
enum DepositRichness {
  TRACE = 'trace',
  POOR = 'poor',
  NORMAL = 'normal',
  RICH = 'rich',
  VERY_RICH = 'very_rich'
}
```

**TileDevelopment接口：**
```typescript
interface TileDevelopment {
  level: number
  experience: number
  experienceToNext: number
  bonuses: {
    productionEfficiency: number
    populationCapacity: number
    buildingSlots: number
    taxIncome: number
  }
}
```

**TerrainConfig接口：**
```typescript
interface TerrainConfig {
  type: TerrainType
  name: string
  buildableRatio: number
  constructionCostModifier: number
  baseAgricultureYield: number
  baseMiningYield: number
  baseForestryYield: number
  populationEfficiency: number
  populationGrowth: number
}
```

### 8.3 地形配置要求

**必须定义的地形配置：**

| 地形类型 | 名称 | 可建设比例 | 农业产量 | 采矿产量 | 人口效率 |
|---------|------|-----------|---------|---------|---------|
| plains | 平原 | 1.0 | 1.0 | 0.3 | 1.0 |
| forest | 森林 | 0.6 | 0.6 | 0.4 | 0.9 |
| hills | 丘陵 | 0.7 | 0.7 | 1.0 | 0.85 |
| water | 水域 | 0.2 | 0.5 | 0.0 | 0.8 |
| desert | 沙漠 | 0.3 | 0.2 | 0.6 | 0.7 |
| snow | 冰雪 | 0.25 | 0.1 | 0.8 | 0.6 |
| swamp | 沼泽 | 0.4 | 0.4 | 0.3 | 0.75 |
| mountain | 山地 | 0.4 | 0.3 | 1.2 | 0.7 |

### 8.4 测试要求

- [ ] Tile接口定义正确
- [ ] ResourceDeposit接口定义正确
- [ ] DepositRichness枚举定义正确
- [ ] TileDevelopment接口定义正确
- [ ] TerrainConfig接口定义正确
- [ ] 所有地形配置定义完整
- [ ] TypeScript类型检查通过

---

## 9. 定义运输模型

### 9.1 创建文件

在 `packages/core/src/models/` 创建 `transport.ts`

### 9.2 接口定义要求

**TransportCapacity接口：**
```typescript
interface TransportCapacity {
  id: string
  tileId: string
  type: TransportType
  level: number
  
  maxCapacity: number
  usedCapacity: number
  
  efficiency: number
  maintenanceCost: number
}
```

**TransportType枚举：**
```typescript
enum TransportType {
  FOOT = 'foot',
  CART = 'cart',
  ROAD = 'road',
  RAILWAY = 'railway',
  HIGHWAY = 'highway',
  AIRPORT = 'airport',
  PORT = 'port'
}
```

**TileTransportCapacity接口：**
```typescript
interface TileTransportCapacity {
  tileId: string
  
  capacities: Map<TransportType, TransportCapacity>
  
  totalCapacity: number
  usedCapacity: number
  availableCapacity: number
  
  efficiency: number
}
```

### 9.3 测试要求

- [ ] TransportCapacity接口定义正确
- [ ] TransportType枚举定义正确
- [ ] TileTransportCapacity接口定义正确
- [ ] TypeScript类型检查通过

---

## 10. 定义游戏状态模型

### 10.1 创建文件

在 `packages/core/src/models/` 创建 `gameState.ts`

### 10.2 接口定义要求

**GameState接口：**
```typescript
interface GameState {
  id: string
  name: string
  version: string
  
  date: GameDate
  era: Era
  tickCount: number
  
  tiles: Map<string, Tile>
  buildings: Map<string, Building>
  populations: Map<string, Population>
  markets: Map<string, Market>
  technologies: Set<string>
  researchQueue: ResearchQueue
  
  resources: {
    money: number
    goods: Map<string, number>
  }
  
  settings: GameSettings
}
```

**GameSettings接口：**
```typescript
interface GameSettings {
  gameSpeed: number
  autoSaveInterval: number
  difficulty: string
  enabledFeatures: {
    events: boolean
    disasters: boolean
    wars: boolean
    trade: boolean
  }
}
```

### 10.3 测试要求

- [ ] GameState接口定义正确
- [ ] GameSettings接口定义正确
- [ ] TypeScript类型检查通过

---

## 11. 创建导出文件

### 11.1 创建 models/index.ts

在 `packages/core/src/models/` 创建 `index.ts`

### 11.2 导出要求

必须导出所有定义的类型、接口、枚举和配置：
- baseTypes.ts 中的所有内容
- goods.ts 中的所有内容
- building.ts 中的所有内容
- productionMethod.ts 中的所有内容
- market.ts 中的所有内容
- population.ts 中的所有内容
- technology.ts 中的所有内容
- tile.ts 中的所有内容
- transport.ts 中的所有内容
- gameState.ts 中的所有内容

### 11.3 测试要求

- [ ] 所有类型、接口、枚举正确导出
- [ ] 所有配置正确导出
- [ ] TypeScript类型检查通过

---

## 12. 编写类型测试

### 12.1 创建测试文件

在 `packages/core/src/models/__tests__/` 创建 `models.test.ts`

### 12.2 测试要求

**基础类型测试：**
- [ ] 验证所有枚举值存在
- [ ] 验证枚举类型正确

**商品模型测试：**
- [ ] 验证Goods接口结构
- [ ] 验证商品配置存在
- [ ] 验证商品配置数据类型正确

**建筑模型测试：**
- [ ] 验证Building接口结构
- [ ] 验证建筑配置存在
- [ ] 验证建筑配置数据类型正确

**生产方式测试：**
- [ ] 验证ProductionMethod接口结构
- [ ] 验证生产方式配置存在
- [ ] 验证自动化等级范围正确（0-1）

**市场模型测试：**
- [ ] 验证Market接口结构
- [ ] 验证Price接口结构
- [ ] 验证MarketEvent接口结构

**人口模型测试：**
- [ ] 验证Population接口结构
- [ ] 验证PopulationGroup接口结构
- [ ] 验证Profession接口结构

**科技模型测试：**
- [ ] 验证Technology接口结构
- [ ] 验证科技配置存在
- [ ] 验证科技解锁数据结构正确

**地块模型测试：**
- [ ] 验证Tile接口结构
- [ ] 验证ResourceDeposit接口结构
- [ ] 验证地形配置存在且完整

**运输模型测试：**
- [ ] 验证TransportCapacity接口结构
- [ ] 验证TransportType枚举存在

**游戏状态测试：**
- [ ] 验证GameState接口结构
- [ ] 验证GameSettings接口结构

**导出测试：**
- [ ] 验证所有类型可从index.ts导入
- [ ] 验证所有配置可从index.ts导入

### 12.3 测试命令

```bash
cd packages/core
pnpm test
```

### 12.4 测试覆盖率要求

- 覆盖率要求：N/A（仅类型定义，无需覆盖率）

---

## 完成标准

### 类型定义完成

- [ ] 所有枚举类型定义完整
- [ ] 所有接口定义完整
- [ ] 所有必需的配置定义完整

### 文件创建完成

- [ ] baseTypes.ts 创建完成
- [ ] goods.ts 创建完成
- [ ] building.ts 创建完成
- [ ] productionMethod.ts 创建完成
- [ ] market.ts 创建完成
- [ ] population.ts 创建完成
- [ ] technology.ts 创建完成
- [ ] tile.ts 创建完成
- [ ] transport.ts 创建完成
- [ ] gameState.ts 创建完成
- [ ] models/index.ts 创建完成

### 测试完成

- [ ] 所有类型测试通过
- [ ] 所有配置数据验证通过
- [ ] 导出测试通过

### 类型检查完成

- [ ] `pnpm typecheck` 通过
- [ ] 无TypeScript错误

---

## 进入下一阶段条件

✅ 所有任务清单完成
✅ 所有接口定义完整
✅ 所有配置定义完整
✅ 类型测试通过
✅ TypeScript类型检查通过
✅ ESLint代码检查通过

---

## 下一步

完成阶段2后，进入[阶段3-基础系统实现](./阶段3-基础系统实现.md)

**重要提醒：** 确保所有类型检查通过后再进入下一阶段！
